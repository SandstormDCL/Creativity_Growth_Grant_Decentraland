export const urlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()!@:%_\+.~#?&\/\/=]*)/gm;
export function validateStep(step) {
    if (!step?.id?.length) {
        throw new Error(`Step: ${JSON.stringify(step)} is missing an 'id'`);
    }
    if (!step?.description?.length) {
        throw new Error(`Step: ${step.id} is missing its description`);
    }
    if (!step.tasks?.length || !Array.isArray(step.tasks)) {
        throw new Error(`Step: ${step.id} contains invalid tasks`);
    }
    const ids = new Set();
    for (const task of step.tasks) {
        validateTask(task);
        if (ids.has(task.id)) {
            throw new Error(`${step.id} is repeated. Each Task's id must be unique`);
        }
        else {
            ids.add(task.id);
        }
    }
    return true;
}
export function validateTask(task) {
    if (!task?.id?.length) {
        throw new Error(`Task: ${JSON.stringify(task)} is missing an 'id'`);
    }
    if (!task?.description?.length) {
        throw new Error(`Task: ${task.id} is missing its description`);
    }
    if (!task?.actionItems?.length || !Array.isArray(task.actionItems)) {
        throw new Error(`Task: ${task.id} contains invalid action items`);
    }
    for (const at of task.actionItems) {
        validateActionItem(at);
    }
    return true;
}
export function validateActionItem(action) {
    switch (action.type) {
        case 'CUSTOM': {
            const keys = Object.keys(action.parameters || {});
            if (!keys.length) {
                throw new Error(`'CUSTOM' Action must contain at least one parameter. eg: 'id'`);
            }
            return true;
        }
        case 'LOCATION': {
            const keys = Object.keys(action.parameters || {});
            if (!keys.includes('x') || !keys.includes('y')) {
                throw new Error(`'LOCATION' Action must contain 'x' and 'y' parameters`);
            }
            return true;
        }
        case 'EMOTE': {
            const keys = Object.keys(action.parameters || {});
            if (!keys.includes('x') || !keys.includes('y') || !keys.includes('id')) {
                throw new Error(`'EMOTE' Action must contain 'x', 'y', and 'id' parameters`);
            }
            return true;
        }
        case 'JUMP': {
            const keys = Object.keys(action.parameters || {});
            if (!keys.includes('x') || !keys.includes('y')) {
                throw new Error(`'JUMP' Action must contain 'x', 'y', and 'id' parameters`);
            }
            return true;
        }
        default:
            throw new Error(`Invalid Action: ${JSON.stringify(action)}`);
    }
}
export function validateStepsAndConnections(quest) {
    if (!quest.definition) {
        throw new Error('Quest must have a definition');
    }
    validateSteps(quest.definition.steps || []);
    if (quest.definition.steps.length > 1) {
        validateConnections(quest.definition.connections || []);
    }
    else {
        return Array.isArray(quest.definition.connections);
    }
    return true;
}
export function validateConnections(connections) {
    if (!connections?.length || !Array.isArray(connections)) {
        throw new Error("Quest's definition must have its connections defined");
    }
    if (!connections.every((connection) => connection.stepFrom?.length && connection.stepTo?.length)) {
        throw new Error("Quest's definition must have valid connections");
    }
    if (!connections.every((connection) => connection.stepFrom != connection.stepTo)) {
        throw new Error("Quest's connections are invalid. A Connection cannot go from and to the same step");
    }
    return true;
}
export function validateSteps(steps) {
    if (!steps?.length || !Array.isArray(steps)) {
        throw new Error("Quest's definition must have its steps defined");
    }
    const ids = new Set();
    for (const step of steps) {
        validateStep(step);
        if (ids.has(step.id)) {
            throw new Error(`${step.id} is repeated. Each Step's id must be unique`);
        }
        else {
            ids.add(step.id);
        }
    }
    return true;
}
export function validateCreateQuest(quest) {
    if (!quest.name || !(quest.name.length >= 5)) {
        throw new Error("Quest's name must be at least 5 chars");
    }
    if (!quest.description || !(quest.description.length >= 5)) {
        throw new Error("Quest's description must be at least 5 chars");
    }
    if (!quest.imageUrl?.length || !new RegExp(urlRegex).test(quest.imageUrl)) {
        throw new Error("Quest's image URL must be a valid URL");
    }
    validateStepsAndConnections(quest);
    if (quest.reward) {
        if (!quest.reward.hook) {
            throw new Error("Quest's reward must have its webhook defined");
        }
        else {
            if (!quest.reward.hook.webhookUrl ||
                !quest.reward.hook.webhookUrl?.length ||
                !new RegExp(urlRegex).test(quest.reward.hook.webhookUrl)) {
                throw new Error("Quest's reward must have a valid Webhook URL");
            }
        }
        if (!quest.reward.items || !quest.reward.items?.length || !Array.isArray(quest.reward.items)) {
            throw new Error("Quest's reward must have its items defined");
        }
        if (!quest.reward.items.every((item) => new RegExp(urlRegex).test(item.imageLink || '') && item?.name && item.name?.length >= 3)) {
            throw new Error("Quest's reward must have valid items");
        }
    }
    return true;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBZ0JBLE1BQU0sQ0FBQyxNQUFNLFFBQVEsR0FDbkIsNEdBQTRHLENBQUE7QUFFOUcsTUFBTSxVQUFVLFlBQVksQ0FBQyxJQUFtQjtJQUM5QyxJQUFJLENBQUMsSUFBSSxFQUFFLEVBQUUsRUFBRSxNQUFNLEVBQUU7UUFDckIsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLHFCQUFxQixDQUFDLENBQUE7S0FDcEU7SUFFRCxJQUFJLENBQUMsSUFBSSxFQUFFLFdBQVcsRUFBRSxNQUFNLEVBQUU7UUFDOUIsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLElBQUksQ0FBQyxFQUFFLDZCQUE2QixDQUFDLENBQUE7S0FDL0Q7SUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssRUFBRSxNQUFNLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRTtRQUNyRCxNQUFNLElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxDQUFDLEVBQUUseUJBQXlCLENBQUMsQ0FBQTtLQUMzRDtJQUVELE1BQU0sR0FBRyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7SUFFckIsS0FBSyxNQUFNLElBQUksSUFBSSxJQUFJLENBQUMsS0FBSyxFQUFFO1FBQzdCLFlBQVksQ0FBQyxJQUFJLENBQUMsQ0FBQTtRQUVsQixJQUFJLEdBQUcsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxFQUFFO1lBQ3BCLE1BQU0sSUFBSSxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsRUFBRSw2Q0FBNkMsQ0FBQyxDQUFBO1NBQ3pFO2FBQU07WUFDTCxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsQ0FBQTtTQUNqQjtLQUNGO0lBRUQsT0FB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QUksQ0FBQyxDQUNsRyxFQUNEO1lBQ0EsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFBO1NBQ3hEO0tBQ0Y7SUFFRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBBY3Rpb24sIENvbm5lY3Rpb24sIFF1ZXN0LCBRdWVzdERlZmluaXRpb24sIFN0ZXAsIFRhc2sgfSBmcm9tICcuL3Byb3RvY29sL2RlY2VudHJhbGFuZC9xdWVzdHMvZGVmaW5pdGlvbnMuZ2VuJ1xuXG5leHBvcnQgdHlwZSBPbWl0dGVkUXVlc3QgPSBPbWl0PFF1ZXN0LCAnaWQnIHwgJ2NyZWF0b3JBZGRyZXNzJyB8ICdhY3RpdmUnIHwgJ2NyZWF0ZWRBdCcgfCAnZGVmaW5pdGlvbic+XG5cbmV4cG9ydCB0eXBlIFJhd1F1ZXN0ID0gT21pdHRlZFF1ZXN0ICYgeyBkZWZpbml0aW9uOiBQYXJ0aWFsPFF1ZXN0RGVmaW5pdGlvbj4gfVxuXG5leHBvcnQgdHlwZSBDcmVhdGVRdWVzdCA9IFBhcnRpYWw8UmF3UXVlc3Q+ICYge1xuICByZXdhcmQ/OiB7XG4gICAgaG9vaz86IHtcbiAgICAgIHdlYmhvb2tVcmw/OiBzdHJpbmdcbiAgICAgIHJlcXVlc3RCb2R5PzogUmVjb3JkPHN0cmluZywgc3RyaW5nPlxuICAgIH1cbiAgICBpdGVtcz86IHsgbmFtZT86IHN0cmluZzsgaW1hZ2VMaW5rPzogc3RyaW5nIH1bXVxuICB9XG59XG5cbmV4cG9ydCBjb25zdCB1cmxSZWdleCA9XG4gIC9odHRwcz86XFwvXFwvKHd3d1xcLik/Wy1hLXpBLVowLTlAOiUuX1xcK34jPV17MSwyNTZ9XFwuW2EtekEtWjAtOSgpXXsxLDZ9XFxiKFstYS16QS1aMC05KCkhQDolX1xcKy5+Iz8mXFwvXFwvPV0qKS9nbVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVTdGVwKHN0ZXA6IFBhcnRpYWw8U3RlcD4pOiBib29sZWFuIHtcbiAgaWYgKCFzdGVwPy5pZD8ubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTdGVwOiAke0pTT04uc3RyaW5naWZ5KHN0ZXApfSBpcyBtaXNzaW5nIGFuICdpZCdgKVxuICB9XG5cbiAgaWYgKCFzdGVwPy5kZXNjcmlwdGlvbj8ubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTdGVwOiAke3N0ZXAuaWR9IGlzIG1pc3NpbmcgaXRzIGRlc2NyaXB0aW9uYClcbiAgfVxuXG4gIGlmICghc3RlcC50YXNrcz8ubGVuZ3RoIHx8ICFBcnJheS5pc0FycmF5KHN0ZXAudGFza3MpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBTdGVwOiAke3N0ZXAuaWR9IGNvbnRhaW5zIGludmFsaWQgdGFza3NgKVxuICB9XG5cbiAgY29uc3QgaWRzID0gbmV3IFNldCgpXG5cbiAgZm9yIChjb25zdCB0YXNrIG9mIHN0ZXAudGFza3MpIHtcbiAgICB2YWxpZGF0ZVRhc2sodGFzaylcblxuICAgIGlmIChpZHMuaGFzKHRhc2suaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7c3RlcC5pZH0gaXMgcmVwZWF0ZWQuIEVhY2ggVGFzaydzIGlkIG11c3QgYmUgdW5pcXVlYClcbiAgICB9IGVsc2Uge1xuICAgICAgaWRzLmFkZCh0YXNrLmlkKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZVRhc2sodGFzazogUGFydGlhbDxUYXNrPik6IGJvb2xlYW4ge1xuICBpZiAoIXRhc2s/LmlkPy5sZW5ndGgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRhc2s6ICR7SlNPTi5zdHJpbmdpZnkodGFzayl9IGlzIG1pc3NpbmcgYW4gJ2lkJ2ApXG4gIH1cblxuICBpZiAoIXRhc2s/LmRlc2NyaXB0aW9uPy5sZW5ndGgpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYFRhc2s6ICR7dGFzay5pZH0gaXMgbWlzc2luZyBpdHMgZGVzY3JpcHRpb25gKVxuICB9XG5cbiAgaWYgKCF0YXNrPy5hY3Rpb25JdGVtcz8ubGVuZ3RoIHx8ICFBcnJheS5pc0FycmF5KHRhc2suYWN0aW9uSXRlbXMpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUYXNrOiAke3Rhc2suaWR9IGNvbnRhaW5zIGludmFsaWQgYWN0aW9uIGl0ZW1zYClcbiAgfVxuXG4gIGZvciAoY29uc3QgYXQgb2YgdGFzay5hY3Rpb25JdGVtcykge1xuICAgIHZhbGlkYXRlQWN0aW9uSXRlbShhdClcbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZUFjdGlvbkl0ZW0oYWN0aW9uOiBQYXJ0aWFsPEFjdGlvbj4pOiBib29sZWFuIHtcbiAgc3dpdGNoIChhY3Rpb24udHlwZSkge1xuICAgIGNhc2UgJ0NVU1RPTSc6IHtcbiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhY3Rpb24ucGFyYW1ldGVycyB8fCB7fSlcbiAgICAgIGlmICgha2V5cy5sZW5ndGgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAnQ1VTVE9NJyBBY3Rpb24gbXVzdCBjb250YWluIGF0IGxlYXN0IG9uZSBwYXJhbWV0ZXIuIGVnOiAnaWQnYClcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIGNhc2UgJ0xPQ0FUSU9OJzoge1xuICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGFjdGlvbi5wYXJhbWV0ZXJzIHx8IHt9KVxuICAgICAgaWYgKCFrZXlzLmluY2x1ZGVzKCd4JykgfHwgIWtleXMuaW5jbHVkZXMoJ3knKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCdMT0NBVElPTicgQWN0aW9uIG11c3QgY29udGFpbiAneCcgYW5kICd5JyBwYXJhbWV0ZXJzYClcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIGNhc2UgJ0VNT1RFJzoge1xuICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGFjdGlvbi5wYXJhbWV0ZXJzIHx8IHt9KVxuICAgICAgaWYgKCFrZXlzLmluY2x1ZGVzKCd4JykgfHwgIWtleXMuaW5jbHVkZXMoJ3knKSB8fCAha2V5cy5pbmNsdWRlcygnaWQnKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCdFTU9URScgQWN0aW9uIG11c3QgY29udGFpbiAneCcsICd5JywgYW5kICdpZCcgcGFyYW1ldGVyc2ApXG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICBjYXNlICdKVU1QJzoge1xuICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKGFjdGlvbi5wYXJhbWV0ZXJzIHx8IHt9KVxuICAgICAgaWYgKCFrZXlzLmluY2x1ZGVzKCd4JykgfHwgIWtleXMuaW5jbHVkZXMoJ3knKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYCdKVU1QJyBBY3Rpb24gbXVzdCBjb250YWluICd4JywgJ3knLCBhbmQgJ2lkJyBwYXJhbWV0ZXJzYClcbiAgICAgIH1cbiAgICAgIHJldHVybiB0cnVlXG4gICAgfVxuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgQWN0aW9uOiAke0pTT04uc3RyaW5naWZ5KGFjdGlvbil9YClcbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVTdGVwc0FuZENvbm5lY3Rpb25zKHF1ZXN0OiBQaWNrPENyZWF0ZVF1ZXN0LCAnZGVmaW5pdGlvbic+KTogYm9vbGVhbiB7XG4gIGlmICghcXVlc3QuZGVmaW5pdGlvbikge1xuICAgIHRocm93IG5ldyBFcnJvcignUXVlc3QgbXVzdCBoYXZlIGEgZGVmaW5pdGlvbicpXG4gIH1cblxuICB2YWxpZGF0ZVN0ZXBzKHF1ZXN0LmRlZmluaXRpb24uc3RlcHMgfHwgW10pXG5cbiAgaWYgKHF1ZXN0LmRlZmluaXRpb24uc3RlcHMhLmxlbmd0aCA+IDEpIHtcbiAgICB2YWxpZGF0ZUNvbm5lY3Rpb25zKHF1ZXN0LmRlZmluaXRpb24uY29ubmVjdGlvbnMgfHwgW10pXG4gIH0gZWxzZSB7XG4gICAgLy8gZGVzcGl0ZSBpdCdzIGEgc2luZ2xlIHN0ZXAgcXVlc3QsICdjb25uZWN0aW9uc2AgZmllbGQgbXVzdCBiZSBkZWZpbmVkXG4gICAgcmV0dXJuIEFycmF5LmlzQXJyYXkocXVlc3QuZGVmaW5pdGlvbi5jb25uZWN0aW9ucylcbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZUNvbm5lY3Rpb25zKGNvbm5lY3Rpb25zOiBDb25uZWN0aW9uW10pOiBib29sZWFuIHtcbiAgaWYgKCFjb25uZWN0aW9ucz8ubGVuZ3RoIHx8ICFBcnJheS5pc0FycmF5KGNvbm5lY3Rpb25zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlF1ZXN0J3MgZGVmaW5pdGlvbiBtdXN0IGhhdmUgaXRzIGNvbm5lY3Rpb25zIGRlZmluZWRcIilcbiAgfVxuXG4gIGlmICghY29ubmVjdGlvbnMuZXZlcnkoKGNvbm5lY3Rpb24pID0+IGNvbm5lY3Rpb24uc3RlcEZyb20/Lmxlbmd0aCAmJiBjb25uZWN0aW9uLnN0ZXBUbz8ubGVuZ3RoKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlF1ZXN0J3MgZGVmaW5pdGlvbiBtdXN0IGhhdmUgdmFsaWQgY29ubmVjdGlvbnNcIilcbiAgfVxuXG4gIGlmICghY29ubmVjdGlvbnMuZXZlcnkoKGNvbm5lY3Rpb24pID0+IGNvbm5lY3Rpb24uc3RlcEZyb20gIT0gY29ubmVjdGlvbi5zdGVwVG8pKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUXVlc3QncyBjb25uZWN0aW9ucyBhcmUgaW52YWxpZC4gQSBDb25uZWN0aW9uIGNhbm5vdCBnbyBmcm9tIGFuZCB0byB0aGUgc2FtZSBzdGVwXCIpXG4gIH1cblxuICByZXR1cm4gdHJ1ZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVTdGVwcyhzdGVwczogU3RlcFtdKTogYm9vbGVhbiB7XG4gIGlmICghc3RlcHM/Lmxlbmd0aCB8fCAhQXJyYXkuaXNBcnJheShzdGVwcykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdCdzIGRlZmluaXRpb24gbXVzdCBoYXZlIGl0cyBzdGVwcyBkZWZpbmVkXCIpXG4gIH1cblxuICBjb25zdCBpZHMgPSBuZXcgU2V0KClcbiAgZm9yIChjb25zdCBzdGVwIG9mIHN0ZXBzKSB7XG4gICAgdmFsaWRhdGVTdGVwKHN0ZXApXG4gICAgaWYgKGlkcy5oYXMoc3RlcC5pZCkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgJHtzdGVwLmlkfSBpcyByZXBlYXRlZC4gRWFjaCBTdGVwJ3MgaWQgbXVzdCBiZSB1bmlxdWVgKVxuICAgIH0gZWxzZSB7XG4gICAgICBpZHMuYWRkKHN0ZXAuaWQpXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRydWVcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlQ3JlYXRlUXVlc3QocXVlc3Q6IENyZWF0ZVF1ZXN0KTogYm9vbGVhbiB7XG4gIGlmICghcXVlc3QubmFtZSB8fCAhKHF1ZXN0Lm5hbWUubGVuZ3RoID49IDUpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUXVlc3QncyBuYW1lIG11c3QgYmUgYXQgbGVhc3QgNSBjaGFyc1wiKVxuICB9XG5cbiAgaWYgKCFxdWVzdC5kZXNjcmlwdGlvbiB8fCAhKHF1ZXN0LmRlc2NyaXB0aW9uLmxlbmd0aCA+PSA1KSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlF1ZXN0J3MgZGVzY3JpcHRpb24gbXVzdCBiZSBhdCBsZWFzdCA1IGNoYXJzXCIpXG4gIH1cblxuICBpZiAoIXF1ZXN0LmltYWdlVXJsPy5sZW5ndGggfHwgIW5ldyBSZWdFeHAodXJsUmVnZXgpLnRlc3QocXVlc3QuaW1hZ2VVcmwpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUXVlc3QncyBpbWFnZSBVUkwgbXVzdCBiZSBhIHZhbGlkIFVSTFwiKVxuICB9XG5cbiAgdmFsaWRhdGVTdGVwc0FuZENvbm5lY3Rpb25zKHF1ZXN0KVxuXG4gIGlmIChxdWVzdC5yZXdhcmQpIHtcbiAgICBpZiAoIXF1ZXN0LnJld2FyZC5ob29rKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdCdzIHJld2FyZCBtdXN0IGhhdmUgaXRzIHdlYmhvb2sgZGVmaW5lZFwiKVxuICAgIH0gZWxzZSB7XG4gICAgICBpZiAoXG4gICAgICAgICFxdWVzdC5yZXdhcmQuaG9vay53ZWJob29rVXJsIHx8XG4gICAgICAgICFxdWVzdC5yZXdhcmQuaG9vay53ZWJob29rVXJsPy5sZW5ndGggfHxcbiAgICAgICAgIW5ldyBSZWdFeHAodXJsUmVnZXgpLnRlc3QocXVlc3QucmV3YXJkLmhvb2sud2ViaG9va1VybClcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdCdzIHJld2FyZCBtdXN0IGhhdmUgYSB2YWxpZCBXZWJob29rIFVSTFwiKVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmICghcXVlc3QucmV3YXJkLml0ZW1zIHx8ICFxdWVzdC5yZXdhcmQuaXRlbXM/Lmxlbmd0aCB8fCAhQXJyYXkuaXNBcnJheShxdWVzdC5yZXdhcmQuaXRlbXMpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdCdzIHJld2FyZCBtdXN0IGhhdmUgaXRzIGl0ZW1zIGRlZmluZWRcIilcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICAhcXVlc3QucmV3YXJkLml0ZW1zLmV2ZXJ5KFxuICAgICAgICAoaXRlbSkgPT4gbmV3IFJlZ0V4cCh1cmxSZWdleCkudGVzdChpdGVtLmltYWdlTGluayB8fCAnJykgJiYgaXRlbT8ubmFtZSAmJiBpdGVtLm5hbWU/Lmxlbmd0aCA+PSAzXG4gICAgICApXG4gICAgKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdCdzIHJld2FyZCBtdXN0IGhhdmUgdmFsaWQgaXRlbXNcIilcbiAgICB9XG4gIH1cblxuICByZXR1cm4gdHJ1ZVxufVxuIl19