import { loadService } from '@dcl/rpc/dist/codegen';
import { createRpcClient } from '@dcl/rpc';
import { WebSocketTransport } from '@dcl/rpc/dist/transports/WebSocket';
import { QuestsServiceDefinition } from './protocol/decentraland/quests/definitions.gen';
import { getHeaders } from '~system/SignedFetch';
export async function createQuestsClient(wsUrl, questId) {
    function handleNewQuestStarted(newQuest) {
        state.instances[newQuest.id] = newQuest;
        if (newQuest.quest.id === questId) {
            state.onStarted.forEach((callback) => callback(newQuest));
        }
    }
    function handleQuestUpdate(questUpdate) {
        const questIdOfInstance = state.instances[questUpdate.instanceId].quest.id;
        if (questIdOfInstance === questId) {
            if (questUpdate.questState) {
                const eventId = questUpdate.eventId;
                state.processingEvents = state.processingEvents.filter((event) => event.eventId !== eventId);
                const { questState, instanceId } = questUpdate;
                state.instances[instanceId].state = questState;
                state.onUpdate.forEach((callback) => callback(state.instances[instanceId]));
            }
        }
    }
    function handleEventIgnored(eventIgnored) {
        state.processingEvents = state.processingEvents.filter((event) => event.eventId !== eventIgnored);
    }
    async function listenToSubscription(subscription) {
        for await (const update of subscription) {
            console.log(`[@dcl/quests-client] update received ${JSON.stringify(update)}`);
            if (update.eventIgnored) {
                handleEventIgnored(update.eventIgnored);
            }
            else if (update.questStateUpdate) {
                handleQuestUpdate(update.questStateUpdate);
            }
            else if (update.newQuestStarted) {
                handleNewQuestStarted(update.newQuestStarted);
            }
        }
    }
    async function sendEvent(event) {
        const eventResponse = await client.sendEvent(event);
        if (eventResponse.acceptedEventId) {
            state.processingEvents.push({ eventId: eventResponse.acceptedEventId, action: event.action });
        }
        return eventResponse;
    }
    function onStarted(callback) {
        state.onStarted.push(callback);
    }
    function onUpdate(callback) {
        state.onUpdate.push(callback);
    }
    function getInstances() {
        return Object.values(state.instances);
    }
    function isQuestStarted() {
        return !!getInstances().find((instance) => instance.quest.id === questId);
    }
    function getQuestInstance() {
        const quest = getInstances().find((instance) => instance.quest.id === questId);
        if (quest)
            return quest;
        return null;
    }
    const state = {
        instances: {},
        processingEvents: [],
        onStarted: [],
        onUpdate: []
    };
    const { client, connection } = await createClient(wsUrl);
    const { startQuest, abortQuest } = client;
    async function start() {
        const response = await startQuest({ questId });
        if (response.accepted) {
            return true;
        }
        else if (response.internalServerError) {
            console.error(`[@dcl/quests-client] Internal Server Error while starting quests`);
            return false;
        }
        else if (response.invalidQuest) {
            console.error(`[@dcl/quests-client] Unable to start the Quest because it's an invalid Quest`);
            return false;
        }
        else if (response.notUuidError) {
            console.error(`[@dcl/quests-client] Provided ID is invalid`);
            return false;
        }
        else if (response.questAlreadyStarted) {
            console.error(`[@dcl/quests-client] The user has already started the Quest`);
            return false;
        }
        return false;
    }
    async function abort() {
        const questInstanceIdForQuestID = getInstances().find((instance) => instance.quest.id === questId);
        if (questInstanceIdForQuestID) {
            const response = await abortQuest({ questInstanceId: questInstanceIdForQuestID.id });
            if (response.accepted) {
                return true;
            }
            else if (response.internalServerError) {
                console.error(`[@dcl/quests-client] Internal Server Error while aborting quests`);
                return false;
            }
            else if (response.notFoundQuestInstance) {
                console.error(`[@dcl/quests-client] Quest Instance ID was not found`);
                return false;
            }
            else if (response.notOwner) {
                console.error(`[@dcl/quests-client] Not Instance Owner`);
                return false;
            }
            else if (response.notUuidError) {
                console.error(`[@dcl/quests-client] Instance ID is invalid`);
                return false;
            }
        }
        console.error(`[@dcl/quests-client] Trying to abort a Quest that is not started`);
        return false;
    }
    const allQuestsResponse = await client.getAllQuests({});
    if (allQuestsResponse.internalServerError) {
        console.error(`[@dcl/quests-client] Internal Server Error while fetching quests`);
        throw new Error(`Couldn't not initialize Quests client`);
    }
    else if (allQuestsResponse.quests) {
        const instances = allQuestsResponse.quests.instances;
        instances.forEach((instance) => {
            state.instances[instance.id] = instance;
        });
        const subscription = client.subscribe({});
        const response = await subscription.next();
        if (!response.done) {
            if (response.value.subscribed) {
                console.log(`[@dcl/quests-client] subscription to updates was confirmed`);
                listenToSubscription(subscription).catch((e) => {
                    console.error(`[@dcl/quests-client] Error while receiving updates: ${e}`);
                });
            }
            else {
                console.error(`[@dcl/quests-client] First message wasn't subscribe confirmation: ${response.value}`);
                connection.close();
                throw new Error('[@dcl/quests-client] Connection broken');
            }
        }
        else {
            console.error(`[@dcl/quests-client] Error while subscribing to updates: ${response.value}`);
            connection.close();
            throw new Error('[@dcl/quests-client] Connection broken');
        }
    }
    return {
        startQuest: start,
        abortQuest: abort,
        isQuestStarted,
        getQuestInstance,
        sendEvent,
        onStarted,
        onUpdate,
        getInstances
    };
}
async function createClient(wsUrl) {
    const ws = new WebSocket(wsUrl);
    return new Promise((resolve, reject) => {
        ws.onopen = async () => {
            const response = await getHeaders({ url: wsUrl });
            ws.send(JSON.stringify(response.headers));
            const transport = WebSocketTransport(ws);
            const rpcClient = await createRpcClient(transport);
            const port = await rpcClient.createPort('quests-client');
            const client = loadService(port, QuestsServiceDefinition);
            resolve({ client, connection: ws });
        };
        ws.onclose = () => {
            reject(`Couldn't connect to Quests server`);
        };
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUUsV0FBVyxFQUFtQixNQUFNLHVCQUF1QixDQUFBO0FBQ3BFLE9BQU8sRUFBRSxlQUFlLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFDMUMsT0FBTyxFQUFFLGtCQUFrQixFQUFFLE1BQU0sb0NBQW9DLENBQUE7QUFDdkUsT0FBTyxFQUlMLHVCQUF1QixFQUd4QixNQUFNLGdEQUFnRCxDQUFBO0FBQ3ZELE9BQU8sRUFBRSxVQUFVLEVBQUUsTUFBTSxxQkFBcUIsQ0FBQTtBQWtCaEQsTUFBTSxDQUFDLEtBQUssVUFBVSxrQkFBa0IsQ0FBQyxLQUFhLEVBQUUsT0FBZTtJQUNyRSxTQUFTLHFCQUFxQixDQUFDLFFBQXVCO1FBQ3BELEtBQUssQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxHQUFHLFFBQVEsQ0FBQTtRQUN2QyxJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLE9BQU8sRUFBRTtZQUNqQyxLQUFLLENBQUMsU0FBUyxDQUFDLE9BQU8sQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxDQUFDLENBQUE7U0FDMUQ7SUFDSCxDQUFDO0lBRUQsU0FBUyxpQkFBaUIsQ0FBQyxXQUE2QjtRQUN0RCxNQUFNLGlCQUFpQixHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUE7UUFDMUUsSUFBSSxpQkFBaUIsS0FBSyxPQUFPLEVBQUU7WUFDakMsSUFBSSxXQUFXLENBQUMsVUFBVSxFQUFFO2dCQUMxQixNQUFNLE9BQU8sR0FBRyxXQUFXLENBQUMsT0FBTyxDQUFBO2dCQUNuQyxLQUFLLENBQUMsZ0JBQWdCLEdBQUcsS0FBSyxDQUFDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFDLEtBQUssRUFBRSxFQUFFLENBQUMsS0FBSyxDQUFDLE9BQU8sS0FBSyxPQUFPLENBQUMsQ0FBQTtnQkFFNUYsTUFBTSxFQUFFLFVBQVUsRUFBRSxVQUFVLEVBQUUsR0FBRyxXQUFXLENBQUE7Z0JBQzlDLEtBQUssQ0FBQyxTQUFTLENBQUMsVUFBVSxDQUFDLENBQUMsS0FBSyxHQUFHLFVBQVUsQ0FBQTtnQkFFOUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLENBQUMsQ0FBQTthQUM1RTtTQUNGO0lBQ0gsQ0FBQztJQUVELFNBQVMsa0JBQWtCLENBQUMsWUFBb0I7UUFDOUMsS0FBSyxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLEtBQUssWUFBWSxDQUFDLENBQUE7SUFDbkcsQ0FBQztJQUVELEtBQUssVUFBVSxvQkFBb0IsQ0FBQyxZQUFzRDtRQUN4RixJQUFJLEtBQUssRUFBRSxNQUFNLE1BQU0sSUFBSSxZQUFZLEVBQUU7WUFDdkMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx3Q0FBd0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLENBQUMsRUFBRSxDQUFDLENBQUE7WUFDN0UsSUFBSSxNQUFNLENBQUMsWUFBWSxFQUFFO2dCQUN2QixrQkFBa0IsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLENBQUE7YUFDeEM7aUJBQU0sSUFBSSxNQUFNLENBQUMsZ0JBQWdCLEVBQUU7Z0JBQ2xDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFBO2FBQzNDO2lCQUFNLElBQUksTUFBTSxDQUFDLGVBQWUsRUFBRTtnQkFDakMscUJBQXFCLENBQUMsTUFBTSxDQUFDLGVBQWdDLENBQUMsQ0FBQTthQUMvRDtTQUNGO0lBQ0gsQ0FBQztJQUVELEtBQUssVUFBVSxTQUFTLENBQUMsS0FBeUI7UUFDaEQsTUFBTSxhQUFhLEdBQUcsTUFBTSxNQUFNLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQyxDQUFBO1FBQ25ELElBQUksYUFBYSxDQUFDLGVBQWUsRUFBRTtZQUNqQyxLQUFLLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEVBQUUsT0FBTyxFQUFFLGFBQWEsQ0FBQyxlQUFlLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFBO1NBQzlGO1FBRUQsT0FBTyxhQUFhLENBQUE7SUFDdEIsQ0FBQztJQUVELFNBQVMsU0FBUyxDQUFDLFFBQTJCO1FBQzVDLEtBQUssQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFBO0lBQ2hDLENBQUM7SUFFRCxTQUFTLFFBQVEsQ0FBQyxRQUEwQjtRQUMxQyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxRQUFRLENBQUMsQ0FBQTtJQUMvQixDQUFDO0lBRUQsU0FBUyxZQUFZO1FBQ25CLE9BQU8sTUFBTSxDQUFDLE1BQU0sQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLENBQUE7SUFDdkMsQ0FBQztJQUVELFNBQVMsY0FBYztRQUNyQixPQUFPLENBQUMsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLE9BQU8sQ0FBQyxDQUFBO0lBQzNFLENBQUM7SUFFRCxTQUFTLGdCQUFnQjtRQUN2QixNQUFNLEtBQUssR0FBRyxZQUFZLEVBQUUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsRUFBRSxLQUFLLE9BQU8sQ0FBQyxDQUFBO1FBQzlFLElBQUksS0FBSztZQUFFLE9BQU8sS0FBSyxDQUFBO1FBRXZCLE9BQU8sSUFBSSxDQUFBO0lBQ2IsQ0FBQztJQUVELE1BQU0sS0FBSyxHQUFnQjtRQUN6QixTQUFTLEVBQUUsRUFBRTtRQUNiLGdCQUFnQixFQUFFLEVBQUU7UUFDcEIsU0FBUyxFQUFFLEVBQUU7UUFDYixRQUFRLEVBQUUsRUFBRTtLQUNiLENBQUE7SUFFRCxNQUFNLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBRSxHQUFHLE1BQU0sWUFBWSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ3hELE1BQU0sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLEdBQUcsTUFBTSxDQUFBO0lBRXpDLEtBQUssVUFBVSxLQUFLO1FBQ2xCLE1BQU0sUUFBUSxHQUFHLE1BQU0sVUFBVSxDQUFDLEVBQUUsT0FBTyxFQUFFLENBQUMsQ0FBQTtRQUM5QyxJQUFJLFFBQVEsQ0FBQyxRQUFRLEVBQUU7WUFDckIsT0FBTyxJQUFJLENBQUE7U0FDWjthQUFNLElBQUksUUFBUSxDQUFDLG1CQUFtQixFQUFFO1lBQ3ZDLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0VBQWtFLENBQUMsQ0FBQTtZQUNqRixPQUFPLEtBQUssQ0FBQTtTQUNiO2FBQU0sSUFBSSxRQUFRLENBQUMsWUFBWSxFQUFFO1lBQ2hDLE9BQU8sQ0FBQyxLQUFLLENBQUMsOEVBQThFLENBQUMsQ0FBQTtZQUM3RixPQUFPLEtBQUssQ0FBQTtTQUNiO2FBQU0sSUFBSSxRQUFRLENBQUMsWUFBWSxFQUFFO1lBQ2hDLE9BQU8sQ0FBQyxLQUFLLENBQUMsNkNBQTZDLENBQUMsQ0FBQTtZQUM1RCxPQUFPLEtBQUssQ0FBQTtTQUNiO2FBQU0sSUFBSSxRQUFRLENBQUMsbUJBQW1CLEVBQUU7WUFDdkMsT0FBTyxDQUFDLEtBQUssQ0FBQyw2REFBNkQsQ0FBQyxDQUFBO1lBQzVFLE9BQU8sS0FBSyxDQUFBO1NBQ2I7UUFDRCxPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFFRCxLQUFLLFVBQVUsS0FBSztRQUNsQixNQUFNLHlCQUF5QixHQUFHLFlBQVksRUFBRSxDQUFDLElBQUksQ0FBQyxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLEtBQUssT0FBTyxDQUFDLENBQUE7UUFDbEcsSUFBSSx5QkFBeUIsRUFBRTtZQUM3QixNQUFNLFFBQVEsR0FBRyxNQUFNLFVBQVUsQ0FBQyxFQUFFLGVBQWUsRUFBRSx5QkFBeUIsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFBO1lBQ3BGLElBQUksUUFBUSxDQUFDLFFBQVEsRUFBRTtnQkFDckIsT0FBTyxJQUFJLENBQUE7YUFDWjtpQkFBTSxJQUFJLFFBQVEsQ0FBQyxtQkFBbUIsRUFBRTtnQkFDdkMsT0FBTyxDQUFDLEtBQUssQ0FBQyxrRUFBa0UsQ0FBQyxDQUFBO2dCQUNqRixPQUFPLEtBQUssQ0FBQTthQUNiO2lCQUFNLElBQUksUUFBUSxDQUFDLHFCQUFxQixFQUFFO2dCQUN6QyxPQUFPLENBQUMsS0FBSyxDQUFDLHNEQUFzRCxDQUFDLENBQUE7Z0JBQ3JFLE9BQU8sS0FBSyxDQUFBO2FBQ2I7aUJBQU0sSUFBSSxRQUFRLENBQUMsUUFBUSxFQUFFO2dCQUM1QixPQUFPLENBQUMsS0FBSyxDQUFDLHlDQUF5QyxDQUFDLENBQUE7Z0JBQ3hELE9BQU8sS0FBSyxDQUFBO2FBQ2I7aUJBQU0sSUFBSSxRQUFRLENBQUMsWUFBWSxFQUFFO2dCQUNoQyxPQUFPLENBQUMsS0FBSyxDQUFDLDZDQUE2QyxDQUFDLENBQUE7Z0JBQzVELE9BQU8sS0FBSyxDQUFBO2FBQ2I7U0FDRjtRQUNELE9BQU8sQ0FBQyxLQUFLLENBQUMsa0VBQWtFLENBQUMsQ0FBQTtRQUNqRixPQUFPLEtBQUssQ0FBQTtJQUNkLENBQUM7SUFFRCxNQUFNLGlCQUFpQixHQUFHLE1BQU0sTUFBTSxDQUFDLFlBQVksQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUN2RCxJQUFJLGlCQUFpQixDQUFDLG1CQUFtQixFQUFFO1FBQ3pDLE9BQU8sQ0FBQyxLQUFLLENBQUMsa0VBQWtFLENBQUMsQ0FBQTtRQUNqRixNQUFNLElBQUksS0FBSyxDQUFDLHVDQUF1QyxDQUFDLENBQUE7S0FDekQ7U0FBTSxJQUFJLGlCQUFpQixDQUFDLE1BQU0sRUFBRTtRQUNuQyxNQUFNLFNBQVMsR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFBO1FBQ3BELFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRTtZQUM3QixLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUF5QixDQUFBO1FBQzFELENBQUMsQ0FBQyxDQUFBO1FBQ0YsTUFBTSxZQUFZLEdBQUcsTUFBTSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUV6QyxNQUFNLFFBQVEsR0FBRyxNQUFNLFlBQVksQ0FBQyxJQUFJLEVBQUUsQ0FBQTtRQUUxQyxJQUFJLENBQUMsUUFBUSxDQUFDLElBQUksRUFBRTtZQUNsQixJQUFJLFFBQVEsQ0FBQyxLQUFLLENBQUMsVUFBVSxFQUFFO2dCQUM3QixPQUFPLENBQUMsR0FBRyxDQUFDLDREQUE0RCxDQUFDLENBQUE7Z0JBQ3pFLG9CQUFvQixDQUFDLFlBQVksQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDLENBQUMsRUFBRSxFQUFFO29CQUM3QyxPQUFPLENBQUMsS0FBSyxDQUFDLHVEQUF1RCxDQUFDLEVBQUUsQ0FBQyxDQUFBO2dCQUMzRSxDQUFDLENBQUMsQ0FBQTthQUNIO2lCQUFNO2dCQUNMLE9BQU8sQ0FBQyxLQUFLLENBQUMscUVBQXFFLFFBQVEsQ0FBQyxLQUFLLEVBQUUsQ0FBQyxDQUFBO2dCQUNwRyxVQUFVLENBQUMsS0FBSyxFQUFFLENBQUE7Z0JBQ2xCLE1BQU0sSUFBSSxLQUFLLENBQUMsd0NBQXdDLENBQUMsQ0FBQTthQUMxRDtTQUNGO2FBQU07WUFDTCxPQUFPLENBQUMsS0FBSyxDQUFDLDREQUE0RCxRQUFRLENBQUMsS0FBSyxFQUFFLENBQUMsQ0FBQTtZQUMzRixVQUFVLENBQUMsS0FBSyxFQUFFLENBQUE7WUFDbEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3Q0FBd0MsQ0FBQyxDQUFBO1NBQzFEO0tBQ0Y7SUFFRCxPQUFPO1FBQ0wsVUFBVSxFQUFFLEtBQUs7UUFDakIsVUFBVSxFQUFFLEtBQUs7UUFDakIsY0FBYztRQUNkLGdCQUFnQjtRQUNoQixTQUFTO1FBQ1QsU0FBUztRQUNULFFBQVE7UUFDUixZQUFZO0tBQ2IsQ0FBQTtBQUNILENBQUM7QUFFRCxLQUFLLFVBQVUsWUFBWSxDQUN6QixLQUFhO0lBRWIsTUFBTSxFQUFFLEdBQUcsSUFBSSxTQUFTLENBQUMsS0FBSyxDQUFDLENBQUE7SUFDL0IsT0FBTyxJQUFJLE9BQU8sQ0FBQyxDQUFDLE9BQU8sRUFBRSxNQUFNLEVBQUUsRUFBRTtRQUNyQyxFQUFFLENBQUMsTUFBTSxHQUFHLEtBQUssSUFBSSxFQUFFO1lBQ3JCLE1BQU0sUUFBUSxHQUFHLE1BQU0sVUFBVSxDQUFDLEVBQUUsR0FBRyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUE7WUFDakQsRUFBRSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFBO1lBRXpDLE1BQU0sU0FBUyxHQUFHLGtCQUFrQixDQUFDLEVBQVMsQ0FBQyxDQUFBO1lBQy9DLE1BQU0sU0FBUyxHQUFHLE1BQU0sZUFBZSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1lBQ2xELE1BQU0sSUFBSSxHQUFHLE1BQU0sU0FBUyxDQUFDLFVBQVUsQ0FBQyxlQUFlLENBQUMsQ0FBQTtZQUN4RCxNQUFNLE1BQU0sR0FBRyxXQUFXLENBQWdELElBQUksRUFBRSx1QkFBdUIsQ0FBQyxDQUFBO1lBQ3hHLE9BQU8sQ0FBQyxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsRUFBRSxFQUFFLENBQUMsQ0FBQTtRQUNyQyxDQUFDLENBQUE7UUFDRCxFQUFFLENBQUMsT0FBTyxHQUFHLEdBQUcsRUFBRTtZQUNoQixNQUFNLENBQUMsbUNBQW1DLENBQUMsQ0FBQTtRQUM3QyxDQUFDLENBQUE7SUFDSCxDQUFDLENBQUMsQ0FBQTtBQUNKLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBsb2FkU2VydmljZSwgUnBjQ2xpZW50TW9kdWxlIH0gZnJvbSAnQGRjbC9ycGMvZGlzdC9jb2RlZ2VuJ1xuaW1wb3J0IHsgY3JlYXRlUnBjQ2xpZW50IH0gZnJvbSAnQGRjbC9ycGMnXG5pbXBvcnQgeyBXZWJTb2NrZXRUcmFuc3BvcnQgfSBmcm9tICdAZGNsL3JwYy9kaXN0L3RyYW5zcG9ydHMvV2ViU29ja2V0J1xuaW1wb3J0IHtcbiAgQWN0aW9uLFxuICBFdmVudFJlc3BvbnNlLFxuICBRdWVzdEluc3RhbmNlIGFzIFF1ZXN0SW5zdGFuY2VQcm90byxcbiAgUXVlc3RzU2VydmljZURlZmluaXRpb24sXG4gIFF1ZXN0U3RhdGVVcGRhdGUsXG4gIFVzZXJVcGRhdGVcbn0gZnJvbSAnLi9wcm90b2NvbC9kZWNlbnRyYWxhbmQvcXVlc3RzL2RlZmluaXRpb25zLmdlbidcbmltcG9ydCB7IGdldEhlYWRlcnMgfSBmcm9tICd+c3lzdGVtL1NpZ25lZEZldGNoJ1xuXG50eXBlIFF1ZXN0c0NsaWVudCA9IHtcbiAgc3RhcnRRdWVzdDogKCkgPT4gUHJvbWlzZTxib29sZWFuPlxuICBhYm9ydFF1ZXN0OiAoKSA9PiBQcm9taXNlPGJvb2xlYW4+XG4gIHNlbmRFdmVudDogKGV2ZW50OiB7IGFjdGlvbjogQWN0aW9uIH0pID0+IFByb21pc2U8RXZlbnRSZXNwb25zZSB8IHVuZGVmaW5lZD5cbiAgb25TdGFydGVkOiAoY2FsbGJhY2s6IE9uU3RhcnRlZENhbGxiYWNrKSA9PiB2b2lkXG4gIG9uVXBkYXRlOiAoY2FsbGJhY2s6IE9uVXBkYXRlQ2FsbGJhY2spID0+IHZvaWRcbiAgaXNRdWVzdFN0YXJ0ZWQ6ICgpID0+IGJvb2xlYW5cbiAgZ2V0UXVlc3RJbnN0YW5jZTogKCkgPT4gUXVlc3RJbnN0YW5jZSB8IG51bGxcbiAgZ2V0SW5zdGFuY2VzOiAoKSA9PiBRdWVzdEluc3RhbmNlW11cbn1cblxuLyoqXG4gKiBAcGFyYW0gd3NVcmwgLSBXZWJTb2NrZXQgVVJMIHRvIGNvbm5lY3QgdG8gdGhlIFF1ZXN0cyBzZXJ2ZXIsIGV4YW1wbGU6IGB3c3M6Ly9xdWVzdHMtcnBjLmRlY2VudHJhbGFuZC57ZW52fWBcbiAqIEBwYXJhbSBxdWVzdElkIC0gSUQgb2YgeW91ciBRdWVzdFxuICogQHJldHVybnMgYSBRdWVzdHMgY2xpZW50IHRoYXQgY2FuIGJlIHVzZWQgdG8gaW50ZXJhY3Qgd2l0aCB0aGUgc2VydmVyXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVRdWVzdHNDbGllbnQod3NVcmw6IHN0cmluZywgcXVlc3RJZDogc3RyaW5nKTogUHJvbWlzZTxRdWVzdHNDbGllbnQ+IHtcbiAgZnVuY3Rpb24gaGFuZGxlTmV3UXVlc3RTdGFydGVkKG5ld1F1ZXN0OiBRdWVzdEluc3RhbmNlKSB7XG4gICAgc3RhdGUuaW5zdGFuY2VzW25ld1F1ZXN0LmlkXSA9IG5ld1F1ZXN0XG4gICAgaWYgKG5ld1F1ZXN0LnF1ZXN0LmlkID09PSBxdWVzdElkKSB7XG4gICAgICBzdGF0ZS5vblN0YXJ0ZWQuZm9yRWFjaCgoY2FsbGJhY2spID0+IGNhbGxiYWNrKG5ld1F1ZXN0KSlcbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVRdWVzdFVwZGF0ZShxdWVzdFVwZGF0ZTogUXVlc3RTdGF0ZVVwZGF0ZSkge1xuICAgIGNvbnN0IHF1ZXN0SWRPZkluc3RhbmNlID0gc3RhdGUuaW5zdGFuY2VzW3F1ZXN0VXBkYXRlLmluc3RhbmNlSWRdLnF1ZXN0LmlkXG4gICAgaWYgKHF1ZXN0SWRPZkluc3RhbmNlID09PSBxdWVzdElkKSB7XG4gICAgICBpZiAocXVlc3RVcGRhdGUucXVlc3RTdGF0ZSkge1xuICAgICAgICBjb25zdCBldmVudElkID0gcXVlc3RVcGRhdGUuZXZlbnRJZFxuICAgICAgICBzdGF0ZS5wcm9jZXNzaW5nRXZlbnRzID0gc3RhdGUucHJvY2Vzc2luZ0V2ZW50cy5maWx0ZXIoKGV2ZW50KSA9PiBldmVudC5ldmVudElkICE9PSBldmVudElkKVxuXG4gICAgICAgIGNvbnN0IHsgcXVlc3RTdGF0ZSwgaW5zdGFuY2VJZCB9ID0gcXVlc3RVcGRhdGVcbiAgICAgICAgc3RhdGUuaW5zdGFuY2VzW2luc3RhbmNlSWRdLnN0YXRlID0gcXVlc3RTdGF0ZVxuXG4gICAgICAgIHN0YXRlLm9uVXBkYXRlLmZvckVhY2goKGNhbGxiYWNrKSA9PiBjYWxsYmFjayhzdGF0ZS5pbnN0YW5jZXNbaW5zdGFuY2VJZF0pKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGhhbmRsZUV2ZW50SWdub3JlZChldmVudElnbm9yZWQ6IHN0cmluZykge1xuICAgIHN0YXRlLnByb2Nlc3NpbmdFdmVudHMgPSBzdGF0ZS5wcm9jZXNzaW5nRXZlbnRzLmZpbHRlcigoZXZlbnQpID0+IGV2ZW50LmV2ZW50SWQgIT09IGV2ZW50SWdub3JlZClcbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIGxpc3RlblRvU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbjogQXN5bmNHZW5lcmF0b3I8VXNlclVwZGF0ZSwgYW55LCB1bmtub3duPikge1xuICAgIGZvciBhd2FpdCAoY29uc3QgdXBkYXRlIG9mIHN1YnNjcmlwdGlvbikge1xuICAgICAgY29uc29sZS5sb2coYFtAZGNsL3F1ZXN0cy1jbGllbnRdIHVwZGF0ZSByZWNlaXZlZCAke0pTT04uc3RyaW5naWZ5KHVwZGF0ZSl9YClcbiAgICAgIGlmICh1cGRhdGUuZXZlbnRJZ25vcmVkKSB7XG4gICAgICAgIGhhbmRsZUV2ZW50SWdub3JlZCh1cGRhdGUuZXZlbnRJZ25vcmVkKVxuICAgICAgfSBlbHNlIGlmICh1cGRhdGUucXVlc3RTdGF0ZVVwZGF0ZSkge1xuICAgICAgICBoYW5kbGVRdWVzdFVwZGF0ZSh1cGRhdGUucXVlc3RTdGF0ZVVwZGF0ZSlcbiAgICAgIH0gZWxzZSBpZiAodXBkYXRlLm5ld1F1ZXN0U3RhcnRlZCkge1xuICAgICAgICBoYW5kbGVOZXdRdWVzdFN0YXJ0ZWQodXBkYXRlLm5ld1F1ZXN0U3RhcnRlZCBhcyBRdWVzdEluc3RhbmNlKVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIHNlbmRFdmVudChldmVudDogeyBhY3Rpb246IEFjdGlvbiB9KSB7XG4gICAgY29uc3QgZXZlbnRSZXNwb25zZSA9IGF3YWl0IGNsaWVudC5zZW5kRXZlbnQoZXZlbnQpXG4gICAgaWYgKGV2ZW50UmVzcG9uc2UuYWNjZXB0ZWRFdmVudElkKSB7XG4gICAgICBzdGF0ZS5wcm9jZXNzaW5nRXZlbnRzLnB1c2goeyBldmVudElkOiBldmVudFJlc3BvbnNlLmFjY2VwdGVkRXZlbnRJZCwgYWN0aW9uOiBldmVudC5hY3Rpb24gfSlcbiAgICB9XG5cbiAgICByZXR1cm4gZXZlbnRSZXNwb25zZVxuICB9XG5cbiAgZnVuY3Rpb24gb25TdGFydGVkKGNhbGxiYWNrOiBPblN0YXJ0ZWRDYWxsYmFjaykge1xuICAgIHN0YXRlLm9uU3RhcnRlZC5wdXNoKGNhbGxiYWNrKVxuICB9XG5cbiAgZnVuY3Rpb24gb25VcGRhdGUoY2FsbGJhY2s6IE9uVXBkYXRlQ2FsbGJhY2spIHtcbiAgICBzdGF0ZS5vblVwZGF0ZS5wdXNoKGNhbGxiYWNrKVxuICB9XG5cbiAgZnVuY3Rpb24gZ2V0SW5zdGFuY2VzKCkge1xuICAgIHJldHVybiBPYmplY3QudmFsdWVzKHN0YXRlLmluc3RhbmNlcylcbiAgfVxuXG4gIGZ1bmN0aW9uIGlzUXVlc3RTdGFydGVkKCkge1xuICAgIHJldHVybiAhIWdldEluc3RhbmNlcygpLmZpbmQoKGluc3RhbmNlKSA9PiBpbnN0YW5jZS5xdWVzdC5pZCA9PT0gcXVlc3RJZClcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldFF1ZXN0SW5zdGFuY2UoKSB7XG4gICAgY29uc3QgcXVlc3QgPSBnZXRJbnN0YW5jZXMoKS5maW5kKChpbnN0YW5jZSkgPT4gaW5zdGFuY2UucXVlc3QuaWQgPT09IHF1ZXN0SWQpXG4gICAgaWYgKHF1ZXN0KSByZXR1cm4gcXVlc3RcblxuICAgIHJldHVybiBudWxsXG4gIH1cblxuICBjb25zdCBzdGF0ZTogQ2xpZW50U3RhdGUgPSB7XG4gICAgaW5zdGFuY2VzOiB7fSxcbiAgICBwcm9jZXNzaW5nRXZlbnRzOiBbXSxcbiAgICBvblN0YXJ0ZWQ6IFtdLFxuICAgIG9uVXBkYXRlOiBbXVxuICB9XG5cbiAgY29uc3QgeyBjbGllbnQsIGNvbm5lY3Rpb24gfSA9IGF3YWl0IGNyZWF0ZUNsaWVudCh3c1VybClcbiAgY29uc3QgeyBzdGFydFF1ZXN0LCBhYm9ydFF1ZXN0IH0gPSBjbGllbnRcblxuICBhc3luYyBmdW5jdGlvbiBzdGFydCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHN0YXJ0UXVlc3QoeyBxdWVzdElkIH0pXG4gICAgaWYgKHJlc3BvbnNlLmFjY2VwdGVkKSB7XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH0gZWxzZSBpZiAocmVzcG9uc2UuaW50ZXJuYWxTZXJ2ZXJFcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gSW50ZXJuYWwgU2VydmVyIEVycm9yIHdoaWxlIHN0YXJ0aW5nIHF1ZXN0c2ApXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmludmFsaWRRdWVzdCkge1xuICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gVW5hYmxlIHRvIHN0YXJ0IHRoZSBRdWVzdCBiZWNhdXNlIGl0J3MgYW4gaW52YWxpZCBRdWVzdGApXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLm5vdFV1aWRFcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gUHJvdmlkZWQgSUQgaXMgaW52YWxpZGApXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLnF1ZXN0QWxyZWFkeVN0YXJ0ZWQpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIFRoZSB1c2VyIGhhcyBhbHJlYWR5IHN0YXJ0ZWQgdGhlIFF1ZXN0YClcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIGFzeW5jIGZ1bmN0aW9uIGFib3J0KCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIGNvbnN0IHF1ZXN0SW5zdGFuY2VJZEZvclF1ZXN0SUQgPSBnZXRJbnN0YW5jZXMoKS5maW5kKChpbnN0YW5jZSkgPT4gaW5zdGFuY2UucXVlc3QuaWQgPT09IHF1ZXN0SWQpXG4gICAgaWYgKHF1ZXN0SW5zdGFuY2VJZEZvclF1ZXN0SUQpIHtcbiAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgYWJvcnRRdWVzdCh7IHF1ZXN0SW5zdGFuY2VJZDogcXVlc3RJbnN0YW5jZUlkRm9yUXVlc3RJRC5pZCB9KVxuICAgICAgaWYgKHJlc3BvbnNlLmFjY2VwdGVkKSB7XG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmludGVybmFsU2VydmVyRXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gSW50ZXJuYWwgU2VydmVyIEVycm9yIHdoaWxlIGFib3J0aW5nIHF1ZXN0c2ApXG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5ub3RGb3VuZFF1ZXN0SW5zdGFuY2UpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gUXVlc3QgSW5zdGFuY2UgSUQgd2FzIG5vdCBmb3VuZGApXG4gICAgICAgIHJldHVybiBmYWxzZVxuICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5ub3RPd25lcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBbQGRjbC9xdWVzdHMtY2xpZW50XSBOb3QgSW5zdGFuY2UgT3duZXJgKVxuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uubm90VXVpZEVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIEluc3RhbmNlIElEIGlzIGludmFsaWRgKVxuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH1cbiAgICB9XG4gICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gVHJ5aW5nIHRvIGFib3J0IGEgUXVlc3QgdGhhdCBpcyBub3Qgc3RhcnRlZGApXG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBjb25zdCBhbGxRdWVzdHNSZXNwb25zZSA9IGF3YWl0IGNsaWVudC5nZXRBbGxRdWVzdHMoe30pXG4gIGlmIChhbGxRdWVzdHNSZXNwb25zZS5pbnRlcm5hbFNlcnZlckVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gSW50ZXJuYWwgU2VydmVyIEVycm9yIHdoaWxlIGZldGNoaW5nIHF1ZXN0c2ApXG4gICAgdGhyb3cgbmV3IEVycm9yKGBDb3VsZG4ndCBub3QgaW5pdGlhbGl6ZSBRdWVzdHMgY2xpZW50YClcbiAgfSBlbHNlIGlmIChhbGxRdWVzdHNSZXNwb25zZS5xdWVzdHMpIHtcbiAgICBjb25zdCBpbnN0YW5jZXMgPSBhbGxRdWVzdHNSZXNwb25zZS5xdWVzdHMuaW5zdGFuY2VzXG4gICAgaW5zdGFuY2VzLmZvckVhY2goKGluc3RhbmNlKSA9PiB7XG4gICAgICBzdGF0ZS5pbnN0YW5jZXNbaW5zdGFuY2UuaWRdID0gaW5zdGFuY2UgYXMgUXVlc3RJbnN0YW5jZVxuICAgIH0pXG4gICAgY29uc3Qgc3Vic2NyaXB0aW9uID0gY2xpZW50LnN1YnNjcmliZSh7fSlcblxuICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgc3Vic2NyaXB0aW9uLm5leHQoKVxuXG4gICAgaWYgKCFyZXNwb25zZS5kb25lKSB7XG4gICAgICBpZiAocmVzcG9uc2UudmFsdWUuc3Vic2NyaWJlZCkge1xuICAgICAgICBjb25zb2xlLmxvZyhgW0BkY2wvcXVlc3RzLWNsaWVudF0gc3Vic2NyaXB0aW9uIHRvIHVwZGF0ZXMgd2FzIGNvbmZpcm1lZGApXG4gICAgICAgIGxpc3RlblRvU3Vic2NyaXB0aW9uKHN1YnNjcmlwdGlvbikuY2F0Y2goKGUpID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKGBbQGRjbC9xdWVzdHMtY2xpZW50XSBFcnJvciB3aGlsZSByZWNlaXZpbmcgdXBkYXRlczogJHtlfWApXG4gICAgICAgIH0pXG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBbQGRjbC9xdWVzdHMtY2xpZW50XSBGaXJzdCBtZXNzYWdlIHdhc24ndCBzdWJzY3JpYmUgY29uZmlybWF0aW9uOiAke3Jlc3BvbnNlLnZhbHVlfWApXG4gICAgICAgIGNvbm5lY3Rpb24uY2xvc2UoKVxuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tAZGNsL3F1ZXN0cy1jbGllbnRdIENvbm5lY3Rpb24gYnJva2VuJylcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gRXJyb3Igd2hpbGUgc3Vic2NyaWJpbmcgdG8gdXBkYXRlczogJHtyZXNwb25zZS52YWx1ZX1gKVxuICAgICAgY29ubmVjdGlvbi5jbG9zZSgpXG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1tAZGNsL3F1ZXN0cy1jbGllbnRdIENvbm5lY3Rpb24gYnJva2VuJylcbiAgICB9XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHN0YXJ0UXVlc3Q6IHN0YXJ0LFxuICAgIGFib3J0UXVlc3Q6IGFib3J0LFxuICAgIGlzUXVlc3RTdGFydGVkLFxuICAgIGdldFF1ZXN0SW5zdGFuY2UsXG4gICAgc2VuZEV2ZW50LFxuICAgIG9uU3RhcnRlZCxcbiAgICBvblVwZGF0ZSxcbiAgICBnZXRJbnN0YW5jZXNcbiAgfVxufVxuXG5hc3luYyBmdW5jdGlvbiBjcmVhdGVDbGllbnQoXG4gIHdzVXJsOiBzdHJpbmdcbik6IFByb21pc2U8eyBjbGllbnQ6IFJwY0NsaWVudE1vZHVsZTxRdWVzdHNTZXJ2aWNlRGVmaW5pdGlvbj47IGNvbm5lY3Rpb246IFdlYlNvY2tldCB9PiB7XG4gIGNvbnN0IHdzID0gbmV3IFdlYlNvY2tldCh3c1VybClcbiAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICB3cy5vbm9wZW4gPSBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGdldEhlYWRlcnMoeyB1cmw6IHdzVXJsIH0pXG4gICAgICB3cy5zZW5kKEpTT04uc3RyaW5naWZ5KHJlc3BvbnNlLmhlYWRlcnMpKVxuXG4gICAgICBjb25zdCB0cmFuc3BvcnQgPSBXZWJTb2NrZXRUcmFuc3BvcnQod3MgYXMgYW55KVxuICAgICAgY29uc3QgcnBjQ2xpZW50ID0gYXdhaXQgY3JlYXRlUnBjQ2xpZW50KHRyYW5zcG9ydClcbiAgICAgIGNvbnN0IHBvcnQgPSBhd2FpdCBycGNDbGllbnQuY3JlYXRlUG9ydCgncXVlc3RzLWNsaWVudCcpXG4gICAgICBjb25zdCBjbGllbnQgPSBsb2FkU2VydmljZTxOb25OdWxsYWJsZTx1bmtub3duPiwgUXVlc3RzU2VydmljZURlZmluaXRpb24+KHBvcnQsIFF1ZXN0c1NlcnZpY2VEZWZpbml0aW9uKVxuICAgICAgcmVzb2x2ZSh7IGNsaWVudCwgY29ubmVjdGlvbjogd3MgfSlcbiAgICB9XG4gICAgd3Mub25jbG9zZSA9ICgpID0+IHtcbiAgICAgIHJlamVjdChgQ291bGRuJ3QgY29ubmVjdCB0byBRdWVzdHMgc2VydmVyYClcbiAgICB9XG4gIH0pXG59XG5cbnR5cGUgQ2xpZW50U3RhdGUgPSB7XG4gIGluc3RhbmNlczogUmVjb3JkPHN0cmluZywgUXVlc3RJbnN0YW5jZT5cbiAgcHJvY2Vzc2luZ0V2ZW50czogQXJyYXk8eyBldmVudElkOiBzdHJpbmc7IGFjdGlvbjogQWN0aW9uIH0+XG4gIG9uU3RhcnRlZDogQXJyYXk8T25TdGFydGVkQ2FsbGJhY2s+XG4gIG9uVXBkYXRlOiBBcnJheTxPblVwZGF0ZUNhbGxiYWNrPlxufVxuXG50eXBlIFJlcXVpcmVkPFQ+ID0gVCAmIHtcbiAgW1AgaW4ga2V5b2YgVF06IE5vbk51bGxhYmxlPFRbUF0+XG59XG5cbmV4cG9ydCB0eXBlIFF1ZXN0SW5zdGFuY2UgPSBSZXF1aXJlZDxRdWVzdEluc3RhbmNlUHJvdG8+XG5cbmV4cG9ydCB0eXBlIE9uU3RhcnRlZENhbGxiYWNrID0gKGluc3RhbmNlOiBRdWVzdEluc3RhbmNlKSA9PiB2b2lkXG5leHBvcnQgdHlwZSBPblVwZGF0ZUNhbGxiYWNrID0gKGluc3RhbmNlOiBRdWVzdEluc3RhbmNlKSA9PiB2b2lkXG4iXX0=