"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.validateCreateQuest = exports.validateSteps = exports.validateConnections = exports.validateStepsAndConnections = exports.validateActionItem = exports.validateTask = exports.validateStep = exports.urlRegex = void 0;
exports.urlRegex = /https?:\/\/(www\.)?[-a-zA-Z0-9@:%._\+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z0-9()!@:%_\+.~#?&\/\/=]*)/gm;
function validateStep(step) {
    if (!step?.id?.length) {
        throw new Error(`Step: ${JSON.stringify(step)} is missing an 'id'`);
    }
    if (!step?.description?.length) {
        throw new Error(`Step: ${step.id} is missing its description`);
    }
    if (!step.tasks?.length || !Array.isArray(step.tasks)) {
        throw new Error(`Step: ${step.id} contains invalid tasks`);
    }
    const ids = new Set();
    for (const task of step.tasks) {
        validateTask(task);
        if (ids.has(task.id)) {
            throw new Error(`${step.id} is repeated. Each Task's id must be unique`);
        }
        else {
            ids.add(task.id);
        }
    }
    return true;
}
exports.validateStep = validateStep;
function validateTask(task) {
    if (!task?.id?.length) {
        throw new Error(`Task: ${JSON.stringify(task)} is missing an 'id'`);
    }
    if (!task?.description?.length) {
        throw new Error(`Task: ${task.id} is missing its description`);
    }
    if (!task?.actionItems?.length || !Array.isArray(task.actionItems)) {
        throw new Error(`Task: ${task.id} contains invalid action items`);
    }
    for (const at of task.actionItems) {
        validateActionItem(at);
    }
    return true;
}
exports.validateTask = validateTask;
function validateActionItem(action) {
    switch (action.type) {
        case 'CUSTOM': {
            const keys = Object.keys(action.parameters || {});
            if (!keys.length) {
                throw new Error(`'CUSTOM' Action must contain at least one parameter. eg: 'id'`);
            }
            return true;
        }
        case 'LOCATION': {
            const keys = Object.keys(action.parameters || {});
            if (!keys.includes('x') || !keys.includes('y')) {
                throw new Error(`'LOCATION' Action must contain 'x' and 'y' parameters`);
            }
            return true;
        }
        case 'EMOTE': {
            const keys = Object.keys(action.parameters || {});
            if (!keys.includes('x') || !keys.includes('y') || !keys.includes('id')) {
                throw new Error(`'EMOTE' Action must contain 'x', 'y', and 'id' parameters`);
            }
            return true;
        }
        case 'JUMP': {
            const keys = Object.keys(action.parameters || {});
            if (!keys.includes('x') || !keys.includes('y')) {
                throw new Error(`'JUMP' Action must contain 'x', 'y', and 'id' parameters`);
            }
            return true;
        }
        default:
            throw new Error(`Invalid Action: ${JSON.stringify(action)}`);
    }
}
exports.validateActionItem = validateActionItem;
function validateStepsAndConnections(quest) {
    if (!quest.definition) {
        throw new Error('Quest must have a definition');
    }
    validateSteps(quest.definition.steps || []);
    if (quest.definition.steps.length > 1) {
        validateConnections(quest.definition.connections || []);
    }
    else {
        return Array.isArray(quest.definition.connections);
    }
    return true;
}
exports.validateStepsAndConnections = validateStepsAndConnections;
function validateConnections(connections) {
    if (!connections?.length || !Array.isArray(connections)) {
        throw new Error("Quest's definition must have its connections defined");
    }
    if (!connections.every((connection) => connection.stepFrom?.length && connection.stepTo?.length)) {
        throw new Error("Quest's definition must have valid connections");
    }
    if (!connections.every((connection) => connection.stepFrom != connection.stepTo)) {
        throw new Error("Quest's connections are invalid. A Connection cannot go from and to the same step");
    }
    return true;
}
exports.validateConnections = validateConnections;
function validateSteps(steps) {
    if (!steps?.length || !Array.isArray(steps)) {
        throw new Error("Quest's definition must have its steps defined");
    }
    const ids = new Set();
    for (const step of steps) {
        validateStep(step);
        if (ids.has(step.id)) {
            throw new Error(`${step.id} is repeated. Each Step's id must be unique`);
        }
        else {
            ids.add(step.id);
        }
    }
    return true;
}
exports.validateSteps = validateSteps;
function validateCreateQuest(quest) {
    if (!quest.name || !(quest.name.length >= 5)) {
        throw new Error("Quest's name must be at least 5 chars");
    }
    if (!quest.description || !(quest.description.length >= 5)) {
        throw new Error("Quest's description must be at least 5 chars");
    }
    if (!quest.imageUrl?.length || !new RegExp(exports.urlRegex).test(quest.imageUrl)) {
        throw new Error("Quest's image URL must be a valid URL");
    }
    validateStepsAndConnections(quest);
    if (quest.reward) {
        if (!quest.reward.hook) {
            throw new Error("Quest's reward must have its webhook defined");
        }
        else {
            if (!quest.reward.hook.webhookUrl ||
                !quest.reward.hook.webhookUrl?.length ||
                !new RegExp(exports.urlRegex).test(quest.reward.hook.webhookUrl)) {
                throw new Error("Quest's reward must have a valid Webhook URL");
            }
        }
        if (!quest.reward.items || !quest.reward.items?.length || !Array.isArray(quest.reward.items)) {
            throw new Error("Quest's reward must have its items defined");
        }
        if (!quest.reward.items.every((item) => new RegExp(exports.urlRegex).test(item.imageLink || '') && item?.name && item.name?.length >= 3)) {
            throw new Error("Quest's reward must have valid items");
        }
    }
    return true;
}
exports.validateCreateQuest = validateCreateQuest;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidXRpbHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdXRpbHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBZ0JhLFFBQUEsUUFBUSxHQUNuQiw0R0FBNEcsQ0FBQTtBQUU5RyxTQUFnQixZQUFZLENBQUMsSUFBbUI7SUFDOUMsSUFBSSxDQUFDLElBQUksRUFBRSxFQUFFLEVBQUUsTUFBTSxFQUFFO1FBQ3JCLE1BQU0sSUFBSSxLQUFLLENBQUMsU0FBUyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxxQkFBcUIsQ0FBQyxDQUFBO0tBQ3BFO0lBRUQsSUFBSSxDQUFDLElBQUksRUFBRSxXQUFXLEVBQUUsTUFBTSxFQUFFO1FBQzlCLE1BQU0sSUFBSSxLQUFLLENBQUMsU0FBUyxJQUFJLENBQUMsRUFBRSw2QkFBNkIsQ0FBQyxDQUFBO0tBQy9EO0lBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLEVBQUU7UUFDckQsTUFBTSxJQUFJLEtBQUssQ0FBQyxTQUFTLElBQUksQ0FBQyxFQUFFLHlCQUF5QixDQUFDLENBQUE7S0FDM0Q7SUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFBO0lBRXJCLEtBQUssTUFBTSxJQUFJLElBQUksSUFBSSxDQUFDLEtBQUssRUFBRTtRQUM3QixZQUFZLENBQUMsSUFBSSxDQUFDLENBQUE7UUFFbEIsSUFBSSxHQUFHLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRTtZQUNwQixNQUFNLElBQUksS0FBSyxDQUFDLEdBQUcsSUFBSSxDQUFDLEVBQUUsNkNBQTZDLENBQUMsQ0FBQTtTQUN6RTthQUFNO1lBQ0wsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUE7U0FDakI7S0FDRjtJQUVELE9BQU8sSUFBSSxDQUFB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RUFBRSxJQUFJLElBQUksSUFBSSxDQUFDLElBQUksRUFBRSxNQUFNLElBQUksQ0FBQyxDQUNsRyxFQUNEO1lBQ0EsTUFBTSxJQUFJLEtBQUssQ0FBQyxzQ0FBc0MsQ0FBQyxDQUFBO1NBQ3hEO0tBQ0Y7SUFFRCxPQUFPLElBQUksQ0FBQTtBQUNiLENBQUM7QUExQ0Qsa0RBMENDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQWN0aW9uLCBDb25uZWN0aW9uLCBRdWVzdCwgUXVlc3REZWZpbml0aW9uLCBTdGVwLCBUYXNrIH0gZnJvbSAnLi9wcm90b2NvbC9kZWNlbnRyYWxhbmQvcXVlc3RzL2RlZmluaXRpb25zLmdlbidcblxuZXhwb3J0IHR5cGUgT21pdHRlZFF1ZXN0ID0gT21pdDxRdWVzdCwgJ2lkJyB8ICdjcmVhdG9yQWRkcmVzcycgfCAnYWN0aXZlJyB8ICdjcmVhdGVkQXQnIHwgJ2RlZmluaXRpb24nPlxuXG5leHBvcnQgdHlwZSBSYXdRdWVzdCA9IE9taXR0ZWRRdWVzdCAmIHsgZGVmaW5pdGlvbjogUGFydGlhbDxRdWVzdERlZmluaXRpb24+IH1cblxuZXhwb3J0IHR5cGUgQ3JlYXRlUXVlc3QgPSBQYXJ0aWFsPFJhd1F1ZXN0PiAmIHtcbiAgcmV3YXJkPzoge1xuICAgIGhvb2s/OiB7XG4gICAgICB3ZWJob29rVXJsPzogc3RyaW5nXG4gICAgICByZXF1ZXN0Qm9keT86IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbiAgICB9XG4gICAgaXRlbXM/OiB7IG5hbWU/OiBzdHJpbmc7IGltYWdlTGluaz86IHN0cmluZyB9W11cbiAgfVxufVxuXG5leHBvcnQgY29uc3QgdXJsUmVnZXggPVxuICAvaHR0cHM/OlxcL1xcLyh3d3dcXC4pP1stYS16QS1aMC05QDolLl9cXCt+Iz1dezEsMjU2fVxcLlthLXpBLVowLTkoKV17MSw2fVxcYihbLWEtekEtWjAtOSgpIUA6JV9cXCsufiM/JlxcL1xcLz1dKikvZ21cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlU3RlcChzdGVwOiBQYXJ0aWFsPFN0ZXA+KTogYm9vbGVhbiB7XG4gIGlmICghc3RlcD8uaWQ/Lmxlbmd0aCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgU3RlcDogJHtKU09OLnN0cmluZ2lmeShzdGVwKX0gaXMgbWlzc2luZyBhbiAnaWQnYClcbiAgfVxuXG4gIGlmICghc3RlcD8uZGVzY3JpcHRpb24/Lmxlbmd0aCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgU3RlcDogJHtzdGVwLmlkfSBpcyBtaXNzaW5nIGl0cyBkZXNjcmlwdGlvbmApXG4gIH1cblxuICBpZiAoIXN0ZXAudGFza3M/Lmxlbmd0aCB8fCAhQXJyYXkuaXNBcnJheShzdGVwLnRhc2tzKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgU3RlcDogJHtzdGVwLmlkfSBjb250YWlucyBpbnZhbGlkIHRhc2tzYClcbiAgfVxuXG4gIGNvbnN0IGlkcyA9IG5ldyBTZXQoKVxuXG4gIGZvciAoY29uc3QgdGFzayBvZiBzdGVwLnRhc2tzKSB7XG4gICAgdmFsaWRhdGVUYXNrKHRhc2spXG5cbiAgICBpZiAoaWRzLmhhcyh0YXNrLmlkKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGAke3N0ZXAuaWR9IGlzIHJlcGVhdGVkLiBFYWNoIFRhc2sncyBpZCBtdXN0IGJlIHVuaXF1ZWApXG4gICAgfSBlbHNlIHtcbiAgICAgIGlkcy5hZGQodGFzay5pZClcbiAgICB9XG4gIH1cblxuICByZXR1cm4gdHJ1ZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVUYXNrKHRhc2s6IFBhcnRpYWw8VGFzaz4pOiBib29sZWFuIHtcbiAgaWYgKCF0YXNrPy5pZD8ubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUYXNrOiAke0pTT04uc3RyaW5naWZ5KHRhc2spfSBpcyBtaXNzaW5nIGFuICdpZCdgKVxuICB9XG5cbiAgaWYgKCF0YXNrPy5kZXNjcmlwdGlvbj8ubGVuZ3RoKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKGBUYXNrOiAke3Rhc2suaWR9IGlzIG1pc3NpbmcgaXRzIGRlc2NyaXB0aW9uYClcbiAgfVxuXG4gIGlmICghdGFzaz8uYWN0aW9uSXRlbXM/Lmxlbmd0aCB8fCAhQXJyYXkuaXNBcnJheSh0YXNrLmFjdGlvbkl0ZW1zKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihgVGFzazogJHt0YXNrLmlkfSBjb250YWlucyBpbnZhbGlkIGFjdGlvbiBpdGVtc2ApXG4gIH1cblxuICBmb3IgKGNvbnN0IGF0IG9mIHRhc2suYWN0aW9uSXRlbXMpIHtcbiAgICB2YWxpZGF0ZUFjdGlvbkl0ZW0oYXQpXG4gIH1cblxuICByZXR1cm4gdHJ1ZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVBY3Rpb25JdGVtKGFjdGlvbjogUGFydGlhbDxBY3Rpb24+KTogYm9vbGVhbiB7XG4gIHN3aXRjaCAoYWN0aW9uLnR5cGUpIHtcbiAgICBjYXNlICdDVVNUT00nOiB7XG4gICAgICBjb25zdCBrZXlzID0gT2JqZWN0LmtleXMoYWN0aW9uLnBhcmFtZXRlcnMgfHwge30pXG4gICAgICBpZiAoIWtleXMubGVuZ3RoKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgJ0NVU1RPTScgQWN0aW9uIG11c3QgY29udGFpbiBhdCBsZWFzdCBvbmUgcGFyYW1ldGVyLiBlZzogJ2lkJ2ApXG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICBjYXNlICdMT0NBVElPTic6IHtcbiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhY3Rpb24ucGFyYW1ldGVycyB8fCB7fSlcbiAgICAgIGlmICgha2V5cy5pbmNsdWRlcygneCcpIHx8ICFrZXlzLmluY2x1ZGVzKCd5JykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAnTE9DQVRJT04nIEFjdGlvbiBtdXN0IGNvbnRhaW4gJ3gnIGFuZCAneScgcGFyYW1ldGVyc2ApXG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICBjYXNlICdFTU9URSc6IHtcbiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhY3Rpb24ucGFyYW1ldGVycyB8fCB7fSlcbiAgICAgIGlmICgha2V5cy5pbmNsdWRlcygneCcpIHx8ICFrZXlzLmluY2x1ZGVzKCd5JykgfHwgIWtleXMuaW5jbHVkZXMoJ2lkJykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAnRU1PVEUnIEFjdGlvbiBtdXN0IGNvbnRhaW4gJ3gnLCAneScsIGFuZCAnaWQnIHBhcmFtZXRlcnNgKVxuICAgICAgfVxuICAgICAgcmV0dXJuIHRydWVcbiAgICB9XG4gICAgY2FzZSAnSlVNUCc6IHtcbiAgICAgIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhhY3Rpb24ucGFyYW1ldGVycyB8fCB7fSlcbiAgICAgIGlmICgha2V5cy5pbmNsdWRlcygneCcpIHx8ICFrZXlzLmluY2x1ZGVzKCd5JykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGAnSlVNUCcgQWN0aW9uIG11c3QgY29udGFpbiAneCcsICd5JywgYW5kICdpZCcgcGFyYW1ldGVyc2ApXG4gICAgICB9XG4gICAgICByZXR1cm4gdHJ1ZVxuICAgIH1cbiAgICBkZWZhdWx0OlxuICAgICAgdGhyb3cgbmV3IEVycm9yKGBJbnZhbGlkIEFjdGlvbjogJHtKU09OLnN0cmluZ2lmeShhY3Rpb24pfWApXG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlU3RlcHNBbmRDb25uZWN0aW9ucyhxdWVzdDogUGljazxDcmVhdGVRdWVzdCwgJ2RlZmluaXRpb24nPik6IGJvb2xlYW4ge1xuICBpZiAoIXF1ZXN0LmRlZmluaXRpb24pIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ1F1ZXN0IG11c3QgaGF2ZSBhIGRlZmluaXRpb24nKVxuICB9XG5cbiAgdmFsaWRhdGVTdGVwcyhxdWVzdC5kZWZpbml0aW9uLnN0ZXBzIHx8IFtdKVxuXG4gIGlmIChxdWVzdC5kZWZpbml0aW9uLnN0ZXBzIS5sZW5ndGggPiAxKSB7XG4gICAgdmFsaWRhdGVDb25uZWN0aW9ucyhxdWVzdC5kZWZpbml0aW9uLmNvbm5lY3Rpb25zIHx8IFtdKVxuICB9IGVsc2Uge1xuICAgIC8vIGRlc3BpdGUgaXQncyBhIHNpbmdsZSBzdGVwIHF1ZXN0LCAnY29ubmVjdGlvbnNgIGZpZWxkIG11c3QgYmUgZGVmaW5lZFxuICAgIHJldHVybiBBcnJheS5pc0FycmF5KHF1ZXN0LmRlZmluaXRpb24uY29ubmVjdGlvbnMpXG4gIH1cblxuICByZXR1cm4gdHJ1ZVxufVxuXG5leHBvcnQgZnVuY3Rpb24gdmFsaWRhdGVDb25uZWN0aW9ucyhjb25uZWN0aW9uczogQ29ubmVjdGlvbltdKTogYm9vbGVhbiB7XG4gIGlmICghY29ubmVjdGlvbnM/Lmxlbmd0aCB8fCAhQXJyYXkuaXNBcnJheShjb25uZWN0aW9ucykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdCdzIGRlZmluaXRpb24gbXVzdCBoYXZlIGl0cyBjb25uZWN0aW9ucyBkZWZpbmVkXCIpXG4gIH1cblxuICBpZiAoIWNvbm5lY3Rpb25zLmV2ZXJ5KChjb25uZWN0aW9uKSA9PiBjb25uZWN0aW9uLnN0ZXBGcm9tPy5sZW5ndGggJiYgY29ubmVjdGlvbi5zdGVwVG8/Lmxlbmd0aCkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdCdzIGRlZmluaXRpb24gbXVzdCBoYXZlIHZhbGlkIGNvbm5lY3Rpb25zXCIpXG4gIH1cblxuICBpZiAoIWNvbm5lY3Rpb25zLmV2ZXJ5KChjb25uZWN0aW9uKSA9PiBjb25uZWN0aW9uLnN0ZXBGcm9tICE9IGNvbm5lY3Rpb24uc3RlcFRvKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlF1ZXN0J3MgY29ubmVjdGlvbnMgYXJlIGludmFsaWQuIEEgQ29ubmVjdGlvbiBjYW5ub3QgZ28gZnJvbSBhbmQgdG8gdGhlIHNhbWUgc3RlcFwiKVxuICB9XG5cbiAgcmV0dXJuIHRydWVcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHZhbGlkYXRlU3RlcHMoc3RlcHM6IFN0ZXBbXSk6IGJvb2xlYW4ge1xuICBpZiAoIXN0ZXBzPy5sZW5ndGggfHwgIUFycmF5LmlzQXJyYXkoc3RlcHMpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKFwiUXVlc3QncyBkZWZpbml0aW9uIG11c3QgaGF2ZSBpdHMgc3RlcHMgZGVmaW5lZFwiKVxuICB9XG5cbiAgY29uc3QgaWRzID0gbmV3IFNldCgpXG4gIGZvciAoY29uc3Qgc3RlcCBvZiBzdGVwcykge1xuICAgIHZhbGlkYXRlU3RlcChzdGVwKVxuICAgIGlmIChpZHMuaGFzKHN0ZXAuaWQpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYCR7c3RlcC5pZH0gaXMgcmVwZWF0ZWQuIEVhY2ggU3RlcCdzIGlkIG11c3QgYmUgdW5pcXVlYClcbiAgICB9IGVsc2Uge1xuICAgICAgaWRzLmFkZChzdGVwLmlkKVxuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlXG59XG5cbmV4cG9ydCBmdW5jdGlvbiB2YWxpZGF0ZUNyZWF0ZVF1ZXN0KHF1ZXN0OiBDcmVhdGVRdWVzdCk6IGJvb2xlYW4ge1xuICBpZiAoIXF1ZXN0Lm5hbWUgfHwgIShxdWVzdC5uYW1lLmxlbmd0aCA+PSA1KSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlF1ZXN0J3MgbmFtZSBtdXN0IGJlIGF0IGxlYXN0IDUgY2hhcnNcIilcbiAgfVxuXG4gIGlmICghcXVlc3QuZGVzY3JpcHRpb24gfHwgIShxdWVzdC5kZXNjcmlwdGlvbi5sZW5ndGggPj0gNSkpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoXCJRdWVzdCdzIGRlc2NyaXB0aW9uIG11c3QgYmUgYXQgbGVhc3QgNSBjaGFyc1wiKVxuICB9XG5cbiAgaWYgKCFxdWVzdC5pbWFnZVVybD8ubGVuZ3RoIHx8ICFuZXcgUmVnRXhwKHVybFJlZ2V4KS50ZXN0KHF1ZXN0LmltYWdlVXJsKSkge1xuICAgIHRocm93IG5ldyBFcnJvcihcIlF1ZXN0J3MgaW1hZ2UgVVJMIG11c3QgYmUgYSB2YWxpZCBVUkxcIilcbiAgfVxuXG4gIHZhbGlkYXRlU3RlcHNBbmRDb25uZWN0aW9ucyhxdWVzdClcblxuICBpZiAocXVlc3QucmV3YXJkKSB7XG4gICAgaWYgKCFxdWVzdC5yZXdhcmQuaG9vaykge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUXVlc3QncyByZXdhcmQgbXVzdCBoYXZlIGl0cyB3ZWJob29rIGRlZmluZWRcIilcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKFxuICAgICAgICAhcXVlc3QucmV3YXJkLmhvb2sud2ViaG9va1VybCB8fFxuICAgICAgICAhcXVlc3QucmV3YXJkLmhvb2sud2ViaG9va1VybD8ubGVuZ3RoIHx8XG4gICAgICAgICFuZXcgUmVnRXhwKHVybFJlZ2V4KS50ZXN0KHF1ZXN0LnJld2FyZC5ob29rLndlYmhvb2tVcmwpXG4gICAgICApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUXVlc3QncyByZXdhcmQgbXVzdCBoYXZlIGEgdmFsaWQgV2ViaG9vayBVUkxcIilcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXF1ZXN0LnJld2FyZC5pdGVtcyB8fCAhcXVlc3QucmV3YXJkLml0ZW1zPy5sZW5ndGggfHwgIUFycmF5LmlzQXJyYXkocXVlc3QucmV3YXJkLml0ZW1zKSkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUXVlc3QncyByZXdhcmQgbXVzdCBoYXZlIGl0cyBpdGVtcyBkZWZpbmVkXCIpXG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgIXF1ZXN0LnJld2FyZC5pdGVtcy5ldmVyeShcbiAgICAgICAgKGl0ZW0pID0+IG5ldyBSZWdFeHAodXJsUmVnZXgpLnRlc3QoaXRlbS5pbWFnZUxpbmsgfHwgJycpICYmIGl0ZW0/Lm5hbWUgJiYgaXRlbS5uYW1lPy5sZW5ndGggPj0gM1xuICAgICAgKVxuICAgICkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKFwiUXVlc3QncyByZXdhcmQgbXVzdCBoYXZlIHZhbGlkIGl0ZW1zXCIpXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHRydWVcbn1cbiJdfQ==