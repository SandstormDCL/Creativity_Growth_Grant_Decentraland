"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.initActionsTracker = void 0;
const ecs_1 = require("@dcl/sdk/ecs");
const observables_1 = require("@dcl/sdk/observables");
const mitt_1 = require("mitt");
function getPlayerParcel() {
    const playerPosition = ecs_1.Transform.getOrNull(ecs_1.engine.PlayerEntity);
    const { z } = playerPosition?.position ?? { z: 0 };
    let { x, y } = playerPosition?.position ?? { x: 0, y: 0, z };
    x = Math.floor(x / 16);
    y = Math.floor(z / 16);
    return { x: `${x}`, y: `${y}` };
}
function initActionsTracker(engine, onActionCallback, ...type) {
    let lastPosition = { x: '0', y: '0' };
    let jumping = false;
    const commonActionsEmitter = (0, mitt_1.default)();
    function checkUserPosition() {
        const position = getPlayerParcel();
        if (position.x === lastPosition.x && position.y === lastPosition.y)
            return;
        lastPosition = position;
        const action = {
            type: 'LOCATION',
            parameters: {
                x: position.x,
                y: position.y
            }
        };
        commonActionsEmitter.emit('action', action);
    }
    function checkUserJump() {
        if (ecs_1.inputSystem.isPressed(8)) {
            if (!jumping) {
                jumping = true;
                const position = getPlayerParcel();
                const action = {
                    type: 'JUMP',
                    parameters: {
                        x: position.x,
                        y: position.y
                    }
                };
                commonActionsEmitter.emit('action', action);
                jumping = false;
            }
        }
        else {
            jumping = false;
        }
    }
    function checkEmotes() {
        observables_1.onPlayerExpressionObservable.add(({ expressionId }) => {
            const position = getPlayerParcel();
            const action = {
                type: 'EMOTE',
                parameters: {
                    id: expressionId,
                    x: position.x,
                    y: position.y
                }
            };
            commonActionsEmitter.emit('action', action);
        });
    }
    if (type.includes('location')) {
        engine.addSystem(checkUserPosition);
    }
    if (type.includes('jump')) {
        engine.addSystem(checkUserJump);
    }
    if (type.includes('emote')) {
        checkEmotes();
    }
    commonActionsEmitter.on('action', (action) => {
        onActionCallback(action);
    });
}
exports.initActionsTracker = initActionsTracker;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3lzdGVtSGVscGVycy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zeXN0ZW1IZWxwZXJzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUFBLHNDQUFtRjtBQUNuRixzREFBbUU7QUFDbkUsK0JBQXVCO0FBRXZCLFNBQVMsZUFBZTtJQUN0QixNQUFNLGNBQWMsR0FBRyxlQUFTLENBQUMsU0FBUyxDQUFDLFlBQU0sQ0FBQyxZQUFZLENBQUMsQ0FBQTtJQUMvRCxNQUFNLEVBQUUsQ0FBQyxFQUFFLEdBQUcsY0FBYyxFQUFFLFFBQVEsSUFBSSxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQTtJQUNsRCxJQUFJLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxHQUFHLGNBQWMsRUFBRSxRQUFRLElBQUksRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUE7SUFFNUQsQ0FBQyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFBO0lBQ3RCLENBQUMsR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsR0FBRyxFQUFFLENBQUMsQ0FBQTtJQUN0QixPQUFPLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxFQUFFLEVBQUUsQ0FBQTtBQUNqQyxDQUFDO0FBZ0RELFNBQWdCLGtCQUFrQixDQUNoQyxNQUFlLEVBQ2YsZ0JBQTJFLEVBQzNFLEdBQUcsSUFBUztJQUVaLElBQUksWUFBWSxHQUFHLEVBQUUsQ0FBQyxFQUFFLEdBQUcsRUFBRSxDQUFDLEVBQUUsR0FBRyxFQUFFLENBQUE7SUFDckMsSUFBSSxPQUFPLEdBQUcsS0FBSyxDQUFBO0lBRW5CLE1BQU0sb0JBQW9CLEdBQUcsSUFBQSxjQUFJLEdBQXVELENBQUE7SUFFeEYsU0FBUyxpQkFBaUI7UUFDeEIsTUFBTSxRQUFRLEdBQUcsZUFBZSxFQUFFLENBQUE7UUFDbEMsSUFBSSxRQUFRLENBQUMsQ0FBQyxLQUFLLFlBQVksQ0FBQyxDQUFDLElBQUksUUFBUSxDQUFDLENBQUMsS0FBSyxZQUFZLENBQUMsQ0FBQztZQUFFLE9BQU07UUFDMUUsWUFBWSxHQUFHLFFBQVEsQ0FBQTtRQUN2QixNQUFNLE1BQU0sR0FBdUI7WUFDakMsSUFBSSxFQUFFLFVBQVU7WUFDaEIsVUFBVSxFQUFFO2dCQUNWLENBQUMsRUFBRSxRQUFRLENBQUMsQ0FBQztnQkFDYixDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7YUFDZDtTQUNGLENBQUE7UUFDRCxvQkFBb0IsQ0FBQyxJQUFJLENBQUMsUUFBUSxFQUFFLE1BQXdCLENBQUMsQ0FBQTtJQUMvRCxDQUFDO0lBRUQsU0FBUyxhQUFhO1FBQ3BCLElBQUksaUJBQVcsQ0FBQyxTQUFTLEdBQXFCLEVBQUU7WUFDOUMsSUFBSSxDQUFDLE9BQU8sRUFBRTtnQkFDWixPQUFPLEdBQUcsSUFBSSxDQUFBO2dCQUNkLE1BQU0sUUFBUSxHQUFHLGVBQWUsRUFBRSxDQUFBO2dCQUNsQyxNQUFNLE1BQU0sR0FBbUI7b0JBQzdCLElBQUksRUFBRSxNQUFNO29CQUNaLFVBQVUsRUFBRTt3QkFDVixDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7d0JBQ2IsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO3FCQUNkO2lCQUNGLENBQUE7Z0JBQ0Qsb0JBQW9CLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxNQUF3QixDQUFDLENBQUE7Z0JBQzdELE9BQU8sR0FBRyxLQUFLLENBQUE7YUFDaEI7U0FDRjthQUFNO1lBQ0wsT0FBTyxHQUFHLEtBQUssQ0FBQTtTQUNoQjtJQUNILENBQUM7SUFFRCxTQUFTLFdBQVc7UUFDbEIsMENBQTRCLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxZQUFZLEVBQUUsRUFBRSxFQUFFO1lBQ3BELE1BQU0sUUFBUSxHQUFHLGVBQWUsRUFBRSxDQUFBO1lBQ2xDLE1BQU0sTUFBTSxHQUFvQjtnQkFDOUIsSUFBSSxFQUFFLE9BQU87Z0JBQ2IsVUFBVSxFQUFFO29CQUNWLEVBQUUsRUFBRSxZQUFZO29CQUNoQixDQUFDLEVBQUUsUUFBUSxDQUFDLENBQUM7b0JBQ2IsQ0FBQyxFQUFFLFFBQVEsQ0FBQyxDQUFDO2lCQUNkO2FBQ0YsQ0FBQTtZQUNELG9CQUFvQixDQUFDLElBQUksQ0FBQyxRQUFRLEVBQUUsTUFBd0IsQ0FBQyxDQUFBO1FBQy9ELENBQUMsQ0FBQyxDQUFBO0lBQ0osQ0FBQztJQUVELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFlLENBQUMsRUFBRTtRQUNsQyxNQUFNLENBQUMsU0FBUyxDQUFDLGlCQUFpQixDQUFDLENBQUE7S0FDcEM7SUFFRCxJQUFJLElBQUksQ0FBQyxRQUFRLENBQUMsTUFBVyxDQUFDLEVBQUU7UUFDOUIsTUFBTSxDQUFDLFNBQVMsQ0FBQyxhQUFhLENBQUMsQ0FBQTtLQUNoQztJQUVELElBQUksSUFBSSxDQUFDLFFBQVEsQ0FBQyxPQUFZLENBQUMsRUFBRTtRQUMvQixXQUFXLEVBQUUsQ0FBQTtLQUNkO0lBRUQsb0JBQW9CLENBQUMsRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDLE1BQU0sRUFBRSxFQUFFO1FBQzNDLGdCQUFnQixDQUFDLE1BQU0sQ0FBQyxDQUFBO0lBQzFCLENBQUMsQ0FBQyxDQUFBO0FBQ0osQ0FBQztBQTFFRCxnREEwRUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBlbmdpbmUsIElFbmdpbmUsIElucHV0QWN0aW9uLCBpbnB1dFN5c3RlbSwgVHJhbnNmb3JtIH0gZnJvbSAnQGRjbC9zZGsvZWNzJ1xuaW1wb3J0IHsgb25QbGF5ZXJFeHByZXNzaW9uT2JzZXJ2YWJsZSB9IGZyb20gJ0BkY2wvc2RrL29ic2VydmFibGVzJ1xuaW1wb3J0IG1pdHQgZnJvbSAnbWl0dCdcblxuZnVuY3Rpb24gZ2V0UGxheWVyUGFyY2VsKCk6IHsgeDogc3RyaW5nOyB5OiBzdHJpbmcgfSB7XG4gIGNvbnN0IHBsYXllclBvc2l0aW9uID0gVHJhbnNmb3JtLmdldE9yTnVsbChlbmdpbmUuUGxheWVyRW50aXR5KVxuICBjb25zdCB7IHogfSA9IHBsYXllclBvc2l0aW9uPy5wb3NpdGlvbiA/PyB7IHo6IDAgfVxuICBsZXQgeyB4LCB5IH0gPSBwbGF5ZXJQb3NpdGlvbj8ucG9zaXRpb24gPz8geyB4OiAwLCB5OiAwLCB6IH1cblxuICB4ID0gTWF0aC5mbG9vcih4IC8gMTYpXG4gIHkgPSBNYXRoLmZsb29yKHogLyAxNilcbiAgcmV0dXJuIHsgeDogYCR7eH1gLCB5OiBgJHt5fWAgfVxufVxuXG50eXBlIEFjdGlvblR5cGUgPSAnbG9jYXRpb24nIHwgJ2p1bXAnIHwgJ2Vtb3RlJ1xuXG50eXBlIExvY2F0aW9uQWN0aW9uVHlwZSA9IHtcbiAgdHlwZTogJ0xPQ0FUSU9OJ1xuICBwYXJhbWV0ZXJzOiB7XG4gICAgeDogc3RyaW5nXG4gICAgeTogc3RyaW5nXG4gIH1cbn1cblxudHlwZSBKdW1wQWN0aW9uVHlwZSA9IHtcbiAgdHlwZTogJ0pVTVAnXG4gIHBhcmFtZXRlcnM6IHtcbiAgICB4OiBzdHJpbmdcbiAgICB5OiBzdHJpbmdcbiAgfVxufVxuXG50eXBlIEVtb3RlQWN0aW9uVHlwZSA9IHtcbiAgdHlwZTogJ0VNT1RFJ1xuICBwYXJhbWV0ZXJzOiB7XG4gICAgeDogc3RyaW5nXG4gICAgeTogc3RyaW5nXG4gICAgaWQ6IHN0cmluZ1xuICB9XG59XG5cbnR5cGUgQWxsID0gTG9jYXRpb25BY3Rpb25UeXBlIHwgSnVtcEFjdGlvblR5cGUgfCBFbW90ZUFjdGlvblR5cGVcblxudHlwZSBJbnZlcnNlRXhjbHVkZTxULCBVPiA9IFQgZXh0ZW5kcyBVID8gVCA6IFVcblxudHlwZSBBY3Rpb25OYXJyb3dpbmc8UyBleHRlbmRzIEFjdGlvblR5cGU+ID0gUyBleHRlbmRzICdsb2NhdGlvbidcbiAgPyBMb2NhdGlvbkFjdGlvblR5cGVcbiAgOiBTIGV4dGVuZHMgJ2p1bXAnXG4gID8gSnVtcEFjdGlvblR5cGVcbiAgOiBTIGV4dGVuZHMgJ2Vtb3RlJ1xuICA/IEVtb3RlQWN0aW9uVHlwZVxuICA6IG5ldmVyXG5cbi8qKlxuICogVHJhY2sgY29tbW9uIGFjdGlvbnMgc3VjaCBhcyBgYGBMT0NBVElPTmBgYCwgYGBgRU1PVEVgYGAgYW5kIGBgYEpVTVBgYGAuIFlvdSBhcmUgYWJsZSB0byB0cmFjayBhbGwgb2YgdGhlbSBvciBvbmx5IGEgc2V0IG9mIHRoZW0uXG4gKiBXaGVuIGFuIGFjdGlvbiBpcyBkb25lIGJ5IHRoZSB1c2VyLCB0aGUgZ2l2ZW4gY2FsbGJhY2sgaXMgZXhlY3V0ZWQuIFlvdSBtYXkgd2FudCB0byBzZW5kIHRoZSBldmVudCB0byB0aGUgUXVlc3RzIFNlcnZpY2UgdGhyb3VnaCBgYGBRdWVzdHNDbGllbnQuc2VuZEV2ZW50YGBgXG4gKiBAcGFyYW0gZW5naW5lIFNESyBFbmdpbmVcbiAqIEBwYXJhbSBvbkFjdGlvbkNhbGxiYWNrIENhbGxiYWNrIHRvIGV4ZWN1dGUgd2hlbiBhbiBhY3Rpb24gaXMgZG9uZSBieSB0aGUgdXNlclxuICogQHBhcmFtIHR5cGUgUG9zc2libGU6YGBgYWxsYGBgIHwgYGBgbG9jYXRpb25gYGAgfCBgYGBqdW1wYGBgIHzCoGBgYGVtb3RlYGBgXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBpbml0QWN0aW9uc1RyYWNrZXI8VCBleHRlbmRzIEFjdGlvblR5cGU+KFxuICBlbmdpbmU6IElFbmdpbmUsXG4gIG9uQWN0aW9uQ2FsbGJhY2s6IChhY3Rpb246IEludmVyc2VFeGNsdWRlPEFsbCwgQWN0aW9uTmFycm93aW5nPFQ+PikgPT4gdm9pZCxcbiAgLi4udHlwZTogVFtdXG4pIHtcbiAgbGV0IGxhc3RQb3NpdGlvbiA9IHsgeDogJzAnLCB5OiAnMCcgfVxuICBsZXQganVtcGluZyA9IGZhbHNlXG5cbiAgY29uc3QgY29tbW9uQWN0aW9uc0VtaXR0ZXIgPSBtaXR0PHsgYWN0aW9uOiBJbnZlcnNlRXhjbHVkZTxBbGwsIEFjdGlvbk5hcnJvd2luZzxUPj4gfT4oKVxuXG4gIGZ1bmN0aW9uIGNoZWNrVXNlclBvc2l0aW9uKCkge1xuICAgIGNvbnN0IHBvc2l0aW9uID0gZ2V0UGxheWVyUGFyY2VsKClcbiAgICBpZiAocG9zaXRpb24ueCA9PT0gbGFzdFBvc2l0aW9uLnggJiYgcG9zaXRpb24ueSA9PT0gbGFzdFBvc2l0aW9uLnkpIHJldHVyblxuICAgIGxhc3RQb3NpdGlvbiA9IHBvc2l0aW9uXG4gICAgY29uc3QgYWN0aW9uOiBMb2NhdGlvbkFjdGlvblR5cGUgPSB7XG4gICAgICB0eXBlOiAnTE9DQVRJT04nLFxuICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICB4OiBwb3NpdGlvbi54LFxuICAgICAgICB5OiBwb3NpdGlvbi55XG4gICAgICB9XG4gICAgfVxuICAgIGNvbW1vbkFjdGlvbnNFbWl0dGVyLmVtaXQoJ2FjdGlvbicsIGFjdGlvbiBhcyB1bmtub3duIGFzIGFueSlcbiAgfVxuXG4gIGZ1bmN0aW9uIGNoZWNrVXNlckp1bXAoKSB7XG4gICAgaWYgKGlucHV0U3lzdGVtLmlzUHJlc3NlZChJbnB1dEFjdGlvbi5JQV9KVU1QKSkge1xuICAgICAgaWYgKCFqdW1waW5nKSB7XG4gICAgICAgIGp1bXBpbmcgPSB0cnVlXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gZ2V0UGxheWVyUGFyY2VsKClcbiAgICAgICAgY29uc3QgYWN0aW9uOiBKdW1wQWN0aW9uVHlwZSA9IHtcbiAgICAgICAgICB0eXBlOiAnSlVNUCcsXG4gICAgICAgICAgcGFyYW1ldGVyczoge1xuICAgICAgICAgICAgeDogcG9zaXRpb24ueCxcbiAgICAgICAgICAgIHk6IHBvc2l0aW9uLnlcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgICAgY29tbW9uQWN0aW9uc0VtaXR0ZXIuZW1pdCgnYWN0aW9uJywgYWN0aW9uIGFzIHVua25vd24gYXMgYW55KVxuICAgICAgICBqdW1waW5nID0gZmFsc2VcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAganVtcGluZyA9IGZhbHNlXG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gY2hlY2tFbW90ZXMoKSB7XG4gICAgb25QbGF5ZXJFeHByZXNzaW9uT2JzZXJ2YWJsZS5hZGQoKHsgZXhwcmVzc2lvbklkIH0pID0+IHtcbiAgICAgIGNvbnN0IHBvc2l0aW9uID0gZ2V0UGxheWVyUGFyY2VsKClcbiAgICAgIGNvbnN0IGFjdGlvbjogRW1vdGVBY3Rpb25UeXBlID0ge1xuICAgICAgICB0eXBlOiAnRU1PVEUnLFxuICAgICAgICBwYXJhbWV0ZXJzOiB7XG4gICAgICAgICAgaWQ6IGV4cHJlc3Npb25JZCxcbiAgICAgICAgICB4OiBwb3NpdGlvbi54LFxuICAgICAgICAgIHk6IHBvc2l0aW9uLnlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgY29tbW9uQWN0aW9uc0VtaXR0ZXIuZW1pdCgnYWN0aW9uJywgYWN0aW9uIGFzIHVua25vd24gYXMgYW55KVxuICAgIH0pXG4gIH1cblxuICBpZiAodHlwZS5pbmNsdWRlcygnbG9jYXRpb24nIGFzIFQpKSB7XG4gICAgZW5naW5lLmFkZFN5c3RlbShjaGVja1VzZXJQb3NpdGlvbilcbiAgfVxuXG4gIGlmICh0eXBlLmluY2x1ZGVzKCdqdW1wJyBhcyBUKSkge1xuICAgIGVuZ2luZS5hZGRTeXN0ZW0oY2hlY2tVc2VySnVtcClcbiAgfVxuXG4gIGlmICh0eXBlLmluY2x1ZGVzKCdlbW90ZScgYXMgVCkpIHtcbiAgICBjaGVja0Vtb3RlcygpXG4gIH1cblxuICBjb21tb25BY3Rpb25zRW1pdHRlci5vbignYWN0aW9uJywgKGFjdGlvbikgPT4ge1xuICAgIG9uQWN0aW9uQ2FsbGJhY2soYWN0aW9uKVxuICB9KVxufVxuIl19