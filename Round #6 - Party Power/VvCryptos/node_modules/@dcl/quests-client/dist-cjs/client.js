"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createQuestsClient = void 0;
const codegen_1 = require("@dcl/rpc/dist/codegen");
const rpc_1 = require("@dcl/rpc");
const WebSocket_1 = require("@dcl/rpc/dist/transports/WebSocket");
const definitions_gen_1 = require("./protocol/decentraland/quests/definitions.gen");
const SignedFetch_1 = require("~system/SignedFetch");
async function createQuestsClient(wsUrl, questId) {
    function handleNewQuestStarted(newQuest) {
        state.instances[newQuest.id] = newQuest;
        if (newQuest.quest.id === questId) {
            state.onStarted.forEach((callback) => callback(newQuest));
        }
    }
    function handleQuestUpdate(questUpdate) {
        const questIdOfInstance = state.instances[questUpdate.instanceId].quest.id;
        if (questIdOfInstance === questId) {
            if (questUpdate.questState) {
                const eventId = questUpdate.eventId;
                state.processingEvents = state.processingEvents.filter((event) => event.eventId !== eventId);
                const { questState, instanceId } = questUpdate;
                state.instances[instanceId].state = questState;
                state.onUpdate.forEach((callback) => callback(state.instances[instanceId]));
            }
        }
    }
    function handleEventIgnored(eventIgnored) {
        state.processingEvents = state.processingEvents.filter((event) => event.eventId !== eventIgnored);
    }
    async function listenToSubscription(subscription) {
        for await (const update of subscription) {
            console.log(`[@dcl/quests-client] update received ${JSON.stringify(update)}`);
            if (update.eventIgnored) {
                handleEventIgnored(update.eventIgnored);
            }
            else if (update.questStateUpdate) {
                handleQuestUpdate(update.questStateUpdate);
            }
            else if (update.newQuestStarted) {
                handleNewQuestStarted(update.newQuestStarted);
            }
        }
    }
    async function sendEvent(event) {
        const eventResponse = await client.sendEvent(event);
        if (eventResponse.acceptedEventId) {
            state.processingEvents.push({ eventId: eventResponse.acceptedEventId, action: event.action });
        }
        return eventResponse;
    }
    function onStarted(callback) {
        state.onStarted.push(callback);
    }
    function onUpdate(callback) {
        state.onUpdate.push(callback);
    }
    function getInstances() {
        return Object.values(state.instances);
    }
    function isQuestStarted() {
        return !!getInstances().find((instance) => instance.quest.id === questId);
    }
    function getQuestInstance() {
        const quest = getInstances().find((instance) => instance.quest.id === questId);
        if (quest)
            return quest;
        return null;
    }
    const state = {
        instances: {},
        processingEvents: [],
        onStarted: [],
        onUpdate: []
    };
    const { client, connection } = await createClient(wsUrl);
    const { startQuest, abortQuest } = client;
    async function start() {
        const response = await startQuest({ questId });
        if (response.accepted) {
            return true;
        }
        else if (response.internalServerError) {
            console.error(`[@dcl/quests-client] Internal Server Error while starting quests`);
            return false;
        }
        else if (response.invalidQuest) {
            console.error(`[@dcl/quests-client] Unable to start the Quest because it's an invalid Quest`);
            return false;
        }
        else if (response.notUuidError) {
            console.error(`[@dcl/quests-client] Provided ID is invalid`);
            return false;
        }
        else if (response.questAlreadyStarted) {
            console.error(`[@dcl/quests-client] The user has already started the Quest`);
            return false;
        }
        return false;
    }
    async function abort() {
        const questInstanceIdForQuestID = getInstances().find((instance) => instance.quest.id === questId);
        if (questInstanceIdForQuestID) {
            const response = await abortQuest({ questInstanceId: questInstanceIdForQuestID.id });
            if (response.accepted) {
                return true;
            }
            else if (response.internalServerError) {
                console.error(`[@dcl/quests-client] Internal Server Error while aborting quests`);
                return false;
            }
            else if (response.notFoundQuestInstance) {
                console.error(`[@dcl/quests-client] Quest Instance ID was not found`);
                return false;
            }
            else if (response.notOwner) {
                console.error(`[@dcl/quests-client] Not Instance Owner`);
                return false;
            }
            else if (response.notUuidError) {
                console.error(`[@dcl/quests-client] Instance ID is invalid`);
                return false;
            }
        }
        console.error(`[@dcl/quests-client] Trying to abort a Quest that is not started`);
        return false;
    }
    const allQuestsResponse = await client.getAllQuests({});
    if (allQuestsResponse.internalServerError) {
        console.error(`[@dcl/quests-client] Internal Server Error while fetching quests`);
        throw new Error(`Couldn't not initialize Quests client`);
    }
    else if (allQuestsResponse.quests) {
        const instances = allQuestsResponse.quests.instances;
        instances.forEach((instance) => {
            state.instances[instance.id] = instance;
        });
        const subscription = client.subscribe({});
        const response = await subscription.next();
        if (!response.done) {
            if (response.value.subscribed) {
                console.log(`[@dcl/quests-client] subscription to updates was confirmed`);
                listenToSubscription(subscription).catch((e) => {
                    console.error(`[@dcl/quests-client] Error while receiving updates: ${e}`);
                });
            }
            else {
                console.error(`[@dcl/quests-client] First message wasn't subscribe confirmation: ${response.value}`);
                connection.close();
                throw new Error('[@dcl/quests-client] Connection broken');
            }
        }
        else {
            console.error(`[@dcl/quests-client] Error while subscribing to updates: ${response.value}`);
            connection.close();
            throw new Error('[@dcl/quests-client] Connection broken');
        }
    }
    return {
        startQuest: start,
        abortQuest: abort,
        isQuestStarted,
        getQuestInstance,
        sendEvent,
        onStarted,
        onUpdate,
        getInstances
    };
}
exports.createQuestsClient = createQuestsClient;
async function createClient(wsUrl) {
    const ws = new WebSocket(wsUrl);
    return new Promise((resolve, reject) => {
        ws.onopen = async () => {
            const response = await (0, SignedFetch_1.getHeaders)({ url: wsUrl });
            ws.send(JSON.stringify(response.headers));
            const transport = (0, WebSocket_1.WebSocketTransport)(ws);
            const rpcClient = await (0, rpc_1.createRpcClient)(transport);
            const port = await rpcClient.createPort('quests-client');
            const client = (0, codegen_1.loadService)(port, definitions_gen_1.QuestsServiceDefinition);
            resolve({ client, connection: ws });
        };
        ws.onclose = () => {
            reject(`Couldn't connect to Quests server`);
        };
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vc3JjL2NsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFBQSxtREFBb0U7QUFDcEUsa0NBQTBDO0FBQzFDLGtFQUF1RTtBQUN2RSxvRkFPdUQ7QUFDdkQscURBQWdEO0FBa0J6QyxLQUFLLFVBQVUsa0JBQWtCLENBQUMsS0FBYSxFQUFFLE9BQWU7SUFDckUsU0FBUyxxQkFBcUIsQ0FBQyxRQUF1QjtRQUNwRCxLQUFLLENBQUMsU0FBUyxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsR0FBRyxRQUFRLENBQUE7UUFDdkMsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLEVBQUUsS0FBSyxPQUFPLEVBQUU7WUFDakMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxRQUFRLEVBQUUsRUFBRSxDQUFDLFFBQVEsQ0FBQyxRQUFRLENBQUMsQ0FBQyxDQUFBO1NBQzFEO0lBQ0gsQ0FBQztJQUVELFNBQVMsaUJBQWlCLENBQUMsV0FBNkI7UUFDdEQsTUFBTSxpQkFBaUIsR0FBRyxLQUFLLENBQUMsU0FBUyxDQUFDLFdBQVcsQ0FBQyxVQUFVLENBQUMsQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFBO1FBQzFFLElBQUksaUJBQWlCLEtBQUssT0FBTyxFQUFFO1lBQ2pDLElBQUksV0FBVyxDQUFDLFVBQVUsRUFBRTtnQkFDMUIsTUFBTSxPQUFPLEdBQUcsV0FBVyxDQUFDLE9BQU8sQ0FBQTtnQkFDbkMsS0FBSyxDQUFDLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQyxLQUFLLEVBQUUsRUFBRSxDQUFDLEtBQUssQ0FBQyxPQUFPLEtBQUssT0FBTyxDQUFDLENBQUE7Z0JBRTVGLE1BQU0sRUFBRSxVQUFVLEVBQUUsVUFBVSxFQUFFLEdBQUcsV0FBVyxDQUFBO2dCQUM5QyxLQUFLLENBQUMsU0FBUyxDQUFDLFVBQVUsQ0FBQyxDQUFDLEtB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QyxLQUFLLENBQUMsQ0FBQTtJQUMvQixPQUFPLElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLE1BQU0sRUFBRSxFQUFFO1FBQ3JDLEVBQUUsQ0FBQyxNQUFNLEdBQUcsS0FBSyxJQUFJLEVBQUU7WUFDckIsTUFBTSxRQUFRLEdBQUcsTUFBTSxJQUFBLHdCQUFVLEVBQUMsRUFBRSxHQUFHLEVBQUUsS0FBSyxFQUFFLENBQUMsQ0FBQTtZQUNqRCxFQUFFLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUE7WUFFekMsTUFBTSxTQUFTLEdBQUcsSUFBQSw4QkFBa0IsRUFBQyxFQUFTLENBQUMsQ0FBQTtZQUMvQyxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUEscUJBQWUsRUFBQyxTQUFTLENBQUMsQ0FBQTtZQUNsRCxNQUFNLElBQUksR0FBRyxNQUFNLFNBQVMsQ0FBQyxVQUFVLENBQUMsZUFBZSxDQUFDLENBQUE7WUFDeEQsTUFBTSxNQUFNLEdBQUcsSUFBQSxxQkFBVyxFQUFnRCxJQUFJLEVBQUUseUNBQXVCLENBQUMsQ0FBQTtZQUN4RyxPQUFPLENBQUMsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFFLEVBQUUsRUFBRSxDQUFDLENBQUE7UUFDckMsQ0FBQyxDQUFBO1FBQ0QsRUFBRSxDQUFDLE9BQU8sR0FBRyxHQUFHLEVBQUU7WUFDaEIsTUFBTSxDQUFDLG1DQUFtQyxDQUFDLENBQUE7UUFDN0MsQ0FBQyxDQUFBO0lBQ0gsQ0FBQyxDQUFDLENBQUE7QUFDSixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgbG9hZFNlcnZpY2UsIFJwY0NsaWVudE1vZHVsZSB9IGZyb20gJ0BkY2wvcnBjL2Rpc3QvY29kZWdlbidcbmltcG9ydCB7IGNyZWF0ZVJwY0NsaWVudCB9IGZyb20gJ0BkY2wvcnBjJ1xuaW1wb3J0IHsgV2ViU29ja2V0VHJhbnNwb3J0IH0gZnJvbSAnQGRjbC9ycGMvZGlzdC90cmFuc3BvcnRzL1dlYlNvY2tldCdcbmltcG9ydCB7XG4gIEFjdGlvbixcbiAgRXZlbnRSZXNwb25zZSxcbiAgUXVlc3RJbnN0YW5jZSBhcyBRdWVzdEluc3RhbmNlUHJvdG8sXG4gIFF1ZXN0c1NlcnZpY2VEZWZpbml0aW9uLFxuICBRdWVzdFN0YXRlVXBkYXRlLFxuICBVc2VyVXBkYXRlXG59IGZyb20gJy4vcHJvdG9jb2wvZGVjZW50cmFsYW5kL3F1ZXN0cy9kZWZpbml0aW9ucy5nZW4nXG5pbXBvcnQgeyBnZXRIZWFkZXJzIH0gZnJvbSAnfnN5c3RlbS9TaWduZWRGZXRjaCdcblxudHlwZSBRdWVzdHNDbGllbnQgPSB7XG4gIHN0YXJ0UXVlc3Q6ICgpID0+IFByb21pc2U8Ym9vbGVhbj5cbiAgYWJvcnRRdWVzdDogKCkgPT4gUHJvbWlzZTxib29sZWFuPlxuICBzZW5kRXZlbnQ6IChldmVudDogeyBhY3Rpb246IEFjdGlvbiB9KSA9PiBQcm9taXNlPEV2ZW50UmVzcG9uc2UgfCB1bmRlZmluZWQ+XG4gIG9uU3RhcnRlZDogKGNhbGxiYWNrOiBPblN0YXJ0ZWRDYWxsYmFjaykgPT4gdm9pZFxuICBvblVwZGF0ZTogKGNhbGxiYWNrOiBPblVwZGF0ZUNhbGxiYWNrKSA9PiB2b2lkXG4gIGlzUXVlc3RTdGFydGVkOiAoKSA9PiBib29sZWFuXG4gIGdldFF1ZXN0SW5zdGFuY2U6ICgpID0+IFF1ZXN0SW5zdGFuY2UgfCBudWxsXG4gIGdldEluc3RhbmNlczogKCkgPT4gUXVlc3RJbnN0YW5jZVtdXG59XG5cbi8qKlxuICogQHBhcmFtIHdzVXJsIC0gV2ViU29ja2V0IFVSTCB0byBjb25uZWN0IHRvIHRoZSBRdWVzdHMgc2VydmVyLCBleGFtcGxlOiBgd3NzOi8vcXVlc3RzLXJwYy5kZWNlbnRyYWxhbmQue2Vudn1gXG4gKiBAcGFyYW0gcXVlc3RJZCAtIElEIG9mIHlvdXIgUXVlc3RcbiAqIEByZXR1cm5zIGEgUXVlc3RzIGNsaWVudCB0aGF0IGNhbiBiZSB1c2VkIHRvIGludGVyYWN0IHdpdGggdGhlIHNlcnZlclxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlUXVlc3RzQ2xpZW50KHdzVXJsOiBzdHJpbmcsIHF1ZXN0SWQ6IHN0cmluZyk6IFByb21pc2U8UXVlc3RzQ2xpZW50PiB7XG4gIGZ1bmN0aW9uIGhhbmRsZU5ld1F1ZXN0U3RhcnRlZChuZXdRdWVzdDogUXVlc3RJbnN0YW5jZSkge1xuICAgIHN0YXRlLmluc3RhbmNlc1tuZXdRdWVzdC5pZF0gPSBuZXdRdWVzdFxuICAgIGlmIChuZXdRdWVzdC5xdWVzdC5pZCA9PT0gcXVlc3RJZCkge1xuICAgICAgc3RhdGUub25TdGFydGVkLmZvckVhY2goKGNhbGxiYWNrKSA9PiBjYWxsYmFjayhuZXdRdWVzdCkpXG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gaGFuZGxlUXVlc3RVcGRhdGUocXVlc3RVcGRhdGU6IFF1ZXN0U3RhdGVVcGRhdGUpIHtcbiAgICBjb25zdCBxdWVzdElkT2ZJbnN0YW5jZSA9IHN0YXRlLmluc3RhbmNlc1txdWVzdFVwZGF0ZS5pbnN0YW5jZUlkXS5xdWVzdC5pZFxuICAgIGlmIChxdWVzdElkT2ZJbnN0YW5jZSA9PT0gcXVlc3RJZCkge1xuICAgICAgaWYgKHF1ZXN0VXBkYXRlLnF1ZXN0U3RhdGUpIHtcbiAgICAgICAgY29uc3QgZXZlbnRJZCA9IHF1ZXN0VXBkYXRlLmV2ZW50SWRcbiAgICAgICAgc3RhdGUucHJvY2Vzc2luZ0V2ZW50cyA9IHN0YXRlLnByb2Nlc3NpbmdFdmVudHMuZmlsdGVyKChldmVudCkgPT4gZXZlbnQuZXZlbnRJZCAhPT0gZXZlbnRJZClcblxuICAgICAgICBjb25zdCB7IHF1ZXN0U3RhdGUsIGluc3RhbmNlSWQgfSA9IHF1ZXN0VXBkYXRlXG4gICAgICAgIHN0YXRlLmluc3RhbmNlc1tpbnN0YW5jZUlkXS5zdGF0ZSA9IHF1ZXN0U3RhdGVcblxuICAgICAgICBzdGF0ZS5vblVwZGF0ZS5mb3JFYWNoKChjYWxsYmFjaykgPT4gY2FsbGJhY2soc3RhdGUuaW5zdGFuY2VzW2luc3RhbmNlSWRdKSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBmdW5jdGlvbiBoYW5kbGVFdmVudElnbm9yZWQoZXZlbnRJZ25vcmVkOiBzdHJpbmcpIHtcbiAgICBzdGF0ZS5wcm9jZXNzaW5nRXZlbnRzID0gc3RhdGUucHJvY2Vzc2luZ0V2ZW50cy5maWx0ZXIoKGV2ZW50KSA9PiBldmVudC5ldmVudElkICE9PSBldmVudElnbm9yZWQpXG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBsaXN0ZW5Ub1N1YnNjcmlwdGlvbihzdWJzY3JpcHRpb246IEFzeW5jR2VuZXJhdG9yPFVzZXJVcGRhdGUsIGFueSwgdW5rbm93bj4pIHtcbiAgICBmb3IgYXdhaXQgKGNvbnN0IHVwZGF0ZSBvZiBzdWJzY3JpcHRpb24pIHtcbiAgICAgIGNvbnNvbGUubG9nKGBbQGRjbC9xdWVzdHMtY2xpZW50XSB1cGRhdGUgcmVjZWl2ZWQgJHtKU09OLnN0cmluZ2lmeSh1cGRhdGUpfWApXG4gICAgICBpZiAodXBkYXRlLmV2ZW50SWdub3JlZCkge1xuICAgICAgICBoYW5kbGVFdmVudElnbm9yZWQodXBkYXRlLmV2ZW50SWdub3JlZClcbiAgICAgIH0gZWxzZSBpZiAodXBkYXRlLnF1ZXN0U3RhdGVVcGRhdGUpIHtcbiAgICAgICAgaGFuZGxlUXVlc3RVcGRhdGUodXBkYXRlLnF1ZXN0U3RhdGVVcGRhdGUpXG4gICAgICB9IGVsc2UgaWYgKHVwZGF0ZS5uZXdRdWVzdFN0YXJ0ZWQpIHtcbiAgICAgICAgaGFuZGxlTmV3UXVlc3RTdGFydGVkKHVwZGF0ZS5uZXdRdWVzdFN0YXJ0ZWQgYXMgUXVlc3RJbnN0YW5jZSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBzZW5kRXZlbnQoZXZlbnQ6IHsgYWN0aW9uOiBBY3Rpb24gfSkge1xuICAgIGNvbnN0IGV2ZW50UmVzcG9uc2UgPSBhd2FpdCBjbGllbnQuc2VuZEV2ZW50KGV2ZW50KVxuICAgIGlmIChldmVudFJlc3BvbnNlLmFjY2VwdGVkRXZlbnRJZCkge1xuICAgICAgc3RhdGUucHJvY2Vzc2luZ0V2ZW50cy5wdXNoKHsgZXZlbnRJZDogZXZlbnRSZXNwb25zZS5hY2NlcHRlZEV2ZW50SWQsIGFjdGlvbjogZXZlbnQuYWN0aW9uIH0pXG4gICAgfVxuXG4gICAgcmV0dXJuIGV2ZW50UmVzcG9uc2VcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uU3RhcnRlZChjYWxsYmFjazogT25TdGFydGVkQ2FsbGJhY2spIHtcbiAgICBzdGF0ZS5vblN0YXJ0ZWQucHVzaChjYWxsYmFjaylcbiAgfVxuXG4gIGZ1bmN0aW9uIG9uVXBkYXRlKGNhbGxiYWNrOiBPblVwZGF0ZUNhbGxiYWNrKSB7XG4gICAgc3RhdGUub25VcGRhdGUucHVzaChjYWxsYmFjaylcbiAgfVxuXG4gIGZ1bmN0aW9uIGdldEluc3RhbmNlcygpIHtcbiAgICByZXR1cm4gT2JqZWN0LnZhbHVlcyhzdGF0ZS5pbnN0YW5jZXMpXG4gIH1cblxuICBmdW5jdGlvbiBpc1F1ZXN0U3RhcnRlZCgpIHtcbiAgICByZXR1cm4gISFnZXRJbnN0YW5jZXMoKS5maW5kKChpbnN0YW5jZSkgPT4gaW5zdGFuY2UucXVlc3QuaWQgPT09IHF1ZXN0SWQpXG4gIH1cblxuICBmdW5jdGlvbiBnZXRRdWVzdEluc3RhbmNlKCkge1xuICAgIGNvbnN0IHF1ZXN0ID0gZ2V0SW5zdGFuY2VzKCkuZmluZCgoaW5zdGFuY2UpID0+IGluc3RhbmNlLnF1ZXN0LmlkID09PSBxdWVzdElkKVxuICAgIGlmIChxdWVzdCkgcmV0dXJuIHF1ZXN0XG5cbiAgICByZXR1cm4gbnVsbFxuICB9XG5cbiAgY29uc3Qgc3RhdGU6IENsaWVudFN0YXRlID0ge1xuICAgIGluc3RhbmNlczoge30sXG4gICAgcHJvY2Vzc2luZ0V2ZW50czogW10sXG4gICAgb25TdGFydGVkOiBbXSxcbiAgICBvblVwZGF0ZTogW11cbiAgfVxuXG4gIGNvbnN0IHsgY2xpZW50LCBjb25uZWN0aW9uIH0gPSBhd2FpdCBjcmVhdGVDbGllbnQod3NVcmwpXG4gIGNvbnN0IHsgc3RhcnRRdWVzdCwgYWJvcnRRdWVzdCB9ID0gY2xpZW50XG5cbiAgYXN5bmMgZnVuY3Rpb24gc3RhcnQoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBzdGFydFF1ZXN0KHsgcXVlc3RJZCB9KVxuICAgIGlmIChyZXNwb25zZS5hY2NlcHRlZCkge1xuICAgICAgcmV0dXJuIHRydWVcbiAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLmludGVybmFsU2VydmVyRXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIEludGVybmFsIFNlcnZlciBFcnJvciB3aGlsZSBzdGFydGluZyBxdWVzdHNgKVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5pbnZhbGlkUXVlc3QpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIFVuYWJsZSB0byBzdGFydCB0aGUgUXVlc3QgYmVjYXVzZSBpdCdzIGFuIGludmFsaWQgUXVlc3RgKVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5ub3RVdWlkRXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIFByb3ZpZGVkIElEIGlzIGludmFsaWRgKVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfSBlbHNlIGlmIChyZXNwb25zZS5xdWVzdEFscmVhZHlTdGFydGVkKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGBbQGRjbC9xdWVzdHMtY2xpZW50XSBUaGUgdXNlciBoYXMgYWxyZWFkeSBzdGFydGVkIHRoZSBRdWVzdGApXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgcmV0dXJuIGZhbHNlXG4gIH1cblxuICBhc3luYyBmdW5jdGlvbiBhYm9ydCgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBxdWVzdEluc3RhbmNlSWRGb3JRdWVzdElEID0gZ2V0SW5zdGFuY2VzKCkuZmluZCgoaW5zdGFuY2UpID0+IGluc3RhbmNlLnF1ZXN0LmlkID09PSBxdWVzdElkKVxuICAgIGlmIChxdWVzdEluc3RhbmNlSWRGb3JRdWVzdElEKSB7XG4gICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGFib3J0UXVlc3QoeyBxdWVzdEluc3RhbmNlSWQ6IHF1ZXN0SW5zdGFuY2VJZEZvclF1ZXN0SUQuaWQgfSlcbiAgICAgIGlmIChyZXNwb25zZS5hY2NlcHRlZCkge1xuICAgICAgICByZXR1cm4gdHJ1ZVxuICAgICAgfSBlbHNlIGlmIChyZXNwb25zZS5pbnRlcm5hbFNlcnZlckVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIEludGVybmFsIFNlcnZlciBFcnJvciB3aGlsZSBhYm9ydGluZyBxdWVzdHNgKVxuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uubm90Rm91bmRRdWVzdEluc3RhbmNlKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIFF1ZXN0IEluc3RhbmNlIElEIHdhcyBub3QgZm91bmRgKVxuICAgICAgICByZXR1cm4gZmFsc2VcbiAgICAgIH0gZWxzZSBpZiAocmVzcG9uc2Uubm90T3duZXIpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gTm90IEluc3RhbmNlIE93bmVyYClcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9IGVsc2UgaWYgKHJlc3BvbnNlLm5vdFV1aWRFcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKGBbQGRjbC9xdWVzdHMtY2xpZW50XSBJbnN0YW5jZSBJRCBpcyBpbnZhbGlkYClcbiAgICAgICAgcmV0dXJuIGZhbHNlXG4gICAgICB9XG4gICAgfVxuICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIFRyeWluZyB0byBhYm9ydCBhIFF1ZXN0IHRoYXQgaXMgbm90IHN0YXJ0ZWRgKVxuICAgIHJldHVybiBmYWxzZVxuICB9XG5cbiAgY29uc3QgYWxsUXVlc3RzUmVzcG9uc2UgPSBhd2FpdCBjbGllbnQuZ2V0QWxsUXVlc3RzKHt9KVxuICBpZiAoYWxsUXVlc3RzUmVzcG9uc2UuaW50ZXJuYWxTZXJ2ZXJFcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIEludGVybmFsIFNlcnZlciBFcnJvciB3aGlsZSBmZXRjaGluZyBxdWVzdHNgKVxuICAgIHRocm93IG5ldyBFcnJvcihgQ291bGRuJ3Qgbm90IGluaXRpYWxpemUgUXVlc3RzIGNsaWVudGApXG4gIH0gZWxzZSBpZiAoYWxsUXVlc3RzUmVzcG9uc2UucXVlc3RzKSB7XG4gICAgY29uc3QgaW5zdGFuY2VzID0gYWxsUXVlc3RzUmVzcG9uc2UucXVlc3RzLmluc3RhbmNlc1xuICAgIGluc3RhbmNlcy5mb3JFYWNoKChpbnN0YW5jZSkgPT4ge1xuICAgICAgc3RhdGUuaW5zdGFuY2VzW2luc3RhbmNlLmlkXSA9IGluc3RhbmNlIGFzIFF1ZXN0SW5zdGFuY2VcbiAgICB9KVxuICAgIGNvbnN0IHN1YnNjcmlwdGlvbiA9IGNsaWVudC5zdWJzY3JpYmUoe30pXG5cbiAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHN1YnNjcmlwdGlvbi5uZXh0KClcblxuICAgIGlmICghcmVzcG9uc2UuZG9uZSkge1xuICAgICAgaWYgKHJlc3BvbnNlLnZhbHVlLnN1YnNjcmliZWQpIHtcbiAgICAgICAgY29uc29sZS5sb2coYFtAZGNsL3F1ZXN0cy1jbGllbnRdIHN1YnNjcmlwdGlvbiB0byB1cGRhdGVzIHdhcyBjb25maXJtZWRgKVxuICAgICAgICBsaXN0ZW5Ub1N1YnNjcmlwdGlvbihzdWJzY3JpcHRpb24pLmNhdGNoKChlKSA9PiB7XG4gICAgICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gRXJyb3Igd2hpbGUgcmVjZWl2aW5nIHVwZGF0ZXM6ICR7ZX1gKVxuICAgICAgICB9KVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgW0BkY2wvcXVlc3RzLWNsaWVudF0gRmlyc3QgbWVzc2FnZSB3YXNuJ3Qgc3Vic2NyaWJlIGNvbmZpcm1hdGlvbjogJHtyZXNwb25zZS52YWx1ZX1gKVxuICAgICAgICBjb25uZWN0aW9uLmNsb3NlKClcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdbQGRjbC9xdWVzdHMtY2xpZW50XSBDb25uZWN0aW9uIGJyb2tlbicpXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoYFtAZGNsL3F1ZXN0cy1jbGllbnRdIEVycm9yIHdoaWxlIHN1YnNjcmliaW5nIHRvIHVwZGF0ZXM6ICR7cmVzcG9uc2UudmFsdWV9YClcbiAgICAgIGNvbm5lY3Rpb24uY2xvc2UoKVxuICAgICAgdGhyb3cgbmV3IEVycm9yKCdbQGRjbC9xdWVzdHMtY2xpZW50XSBDb25uZWN0aW9uIGJyb2tlbicpXG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIHtcbiAgICBzdGFydFF1ZXN0OiBzdGFydCxcbiAgICBhYm9ydFF1ZXN0OiBhYm9ydCxcbiAgICBpc1F1ZXN0U3RhcnRlZCxcbiAgICBnZXRRdWVzdEluc3RhbmNlLFxuICAgIHNlbmRFdmVudCxcbiAgICBvblN0YXJ0ZWQsXG4gICAgb25VcGRhdGUsXG4gICAgZ2V0SW5zdGFuY2VzXG4gIH1cbn1cblxuYXN5bmMgZnVuY3Rpb24gY3JlYXRlQ2xpZW50KFxuICB3c1VybDogc3RyaW5nXG4pOiBQcm9taXNlPHsgY2xpZW50OiBScGNDbGllbnRNb2R1bGU8UXVlc3RzU2VydmljZURlZmluaXRpb24+OyBjb25uZWN0aW9uOiBXZWJTb2NrZXQgfT4ge1xuICBjb25zdCB3cyA9IG5ldyBXZWJTb2NrZXQod3NVcmwpXG4gIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgd3Mub25vcGVuID0gYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBnZXRIZWFkZXJzKHsgdXJsOiB3c1VybCB9KVxuICAgICAgd3Muc2VuZChKU09OLnN0cmluZ2lmeShyZXNwb25zZS5oZWFkZXJzKSlcblxuICAgICAgY29uc3QgdHJhbnNwb3J0ID0gV2ViU29ja2V0VHJhbnNwb3J0KHdzIGFzIGFueSlcbiAgICAgIGNvbnN0IHJwY0NsaWVudCA9IGF3YWl0IGNyZWF0ZVJwY0NsaWVudCh0cmFuc3BvcnQpXG4gICAgICBjb25zdCBwb3J0ID0gYXdhaXQgcnBjQ2xpZW50LmNyZWF0ZVBvcnQoJ3F1ZXN0cy1jbGllbnQnKVxuICAgICAgY29uc3QgY2xpZW50ID0gbG9hZFNlcnZpY2U8Tm9uTnVsbGFibGU8dW5rbm93bj4sIFF1ZXN0c1NlcnZpY2VEZWZpbml0aW9uPihwb3J0LCBRdWVzdHNTZXJ2aWNlRGVmaW5pdGlvbilcbiAgICAgIHJlc29sdmUoeyBjbGllbnQsIGNvbm5lY3Rpb246IHdzIH0pXG4gICAgfVxuICAgIHdzLm9uY2xvc2UgPSAoKSA9PiB7XG4gICAgICByZWplY3QoYENvdWxkbid0IGNvbm5lY3QgdG8gUXVlc3RzIHNlcnZlcmApXG4gICAgfVxuICB9KVxufVxuXG50eXBlIENsaWVudFN0YXRlID0ge1xuICBpbnN0YW5jZXM6IFJlY29yZDxzdHJpbmcsIFF1ZXN0SW5zdGFuY2U+XG4gIHByb2Nlc3NpbmdFdmVudHM6IEFycmF5PHsgZXZlbnRJZDogc3RyaW5nOyBhY3Rpb246IEFjdGlvbiB9PlxuICBvblN0YXJ0ZWQ6IEFycmF5PE9uU3RhcnRlZENhbGxiYWNrPlxuICBvblVwZGF0ZTogQXJyYXk8T25VcGRhdGVDYWxsYmFjaz5cbn1cblxudHlwZSBSZXF1aXJlZDxUPiA9IFQgJiB7XG4gIFtQIGluIGtleW9mIFRdOiBOb25OdWxsYWJsZTxUW1BdPlxufVxuXG5leHBvcnQgdHlwZSBRdWVzdEluc3RhbmNlID0gUmVxdWlyZWQ8UXVlc3RJbnN0YW5jZVByb3RvPlxuXG5leHBvcnQgdHlwZSBPblN0YXJ0ZWRDYWxsYmFjayA9IChpbnN0YW5jZTogUXVlc3RJbnN0YW5jZSkgPT4gdm9pZFxuZXhwb3J0IHR5cGUgT25VcGRhdGVDYWxsYmFjayA9IChpbnN0YW5jZTogUXVlc3RJbnN0YW5jZSkgPT4gdm9pZFxuIl19