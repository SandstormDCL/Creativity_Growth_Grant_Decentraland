import { getTriggerEvents } from './events';
import { TriggerType } from './enums';
export const tickSet = new Set();
const queueDelay = new Map();
const queueInterval = new Map();
export function createTimerSystem() {
    return function timerSystem(dt) {
        intervalSystem(dt);
        delaySystem(dt);
        tickSystem(dt);
    };
    function intervalSystem(dt) {
        for (const [entity, actions] of queueInterval.entries()) {
            const triggerEvents = getTriggerEvents(entity);
            for (const action of actions) {
                if (action.timeout === action.interval) {
                    action.callback();
                }
                action.timeout -= dt;
                if (action.timeout <= 0) {
                    action.timeout = action.interval;
                    triggerEvents.emit(TriggerType.ON_LOOP);
                }
            }
        }
    }
    function delaySystem(dt) {
        for (const [entity, actions] of queueDelay.entries()) {
            const triggerEvents = getTriggerEvents(entity);
            const completedActions = [];
            let idx = 0;
            for (const action of actions) {
                action.timeout -= dt;
                if (action.timeout <= 0) {
                    action.callback();
                    triggerEvents.emit(TriggerType.ON_DELAY);
                    completedActions.push(idx);
                }
                idx++;
            }
            for (const action of completedActions) {
                actions.splice(action, 1);
            }
        }
    }
    function tickSystem(_dt) {
        for (const entity of tickSet) {
            const triggerEvents = getTriggerEvents(entity);
            triggerEvents.emit(TriggerType.ON_TICK);
        }
    }
}
export function startTimeout(entity, action, timeout, callback) {
    const actionCallbacks = queueDelay.get(entity) ?? [];
    actionCallbacks.push({ timeout, action, callback });
    queueDelay.set(entity, actionCallbacks);
}
export function stopTimeout(entity, action) {
    const delays = queueDelay.get(entity) ?? [];
    queueDelay.set(entity, delays.filter(($) => $.action !== action));
}
export function stopAllTimeouts(entity) {
    queueDelay.delete(entity);
}
export function startInterval(entity, action, interval, callback) {
    const actionCallbacks = queueInterval.get(entity) ?? [];
    actionCallbacks.push({ timeout: interval, action, callback, interval });
    queueInterval.set(entity, actionCallbacks);
}
export function stopInterval(entity, action) {
    const intervals = queueInterval.get(entity) ?? [];
    queueInterval.set(entity, intervals.filter(($) => $.action !== action));
}
export function stopAllIntervals(entity) {
    queueInterval.delete(entity);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi9zcmMvdGltZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQ0EsT0FBTyxFQUFFLGdCQUFnQixFQUFFLE1BQU0sVUFBVSxDQUFBO0FBQzNDLE9BQU8sRUFBRSxXQUFXLEVBQUUsTUFBTSxTQUFTLENBQUE7QUFlckMsTUFBTSxDQUFDLE1BQU0sT0FBTyxHQUFHLElBQUksR0FBRyxFQUFVLENBQUE7QUFFeEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxHQUFHLEVBQThCLENBQUE7QUFDeEQsTUFBTSxhQUFhLEdBQUcsSUFBSSxHQUFHLEVBQWlDLENBQUE7QUFFOUQsTUFBTSxVQUFVLGlCQUFpQjtJQUMvQixPQUFPLFNBQVMsV0FBVyxDQUFDLEVBQVU7UUFDcEMsY0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFBO1FBQ2xCLFdBQVcsQ0FBQyxFQUFFLENBQUMsQ0FBQTtRQUNmLFVBQVUsQ0FBQyxFQUFFLENBQUMsQ0FBQTtJQUNoQixDQUFDLENBQUE7SUFFRCxTQUFTLGNBQWMsQ0FBQyxFQUFVO1FBQ2hDLEtBQUssTUFBTSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsSUFBSSxhQUFhLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztZQUN4RCxNQUFNLGFBQWEsR0FBRyxnQkFBZ0IsQ0FBQyxNQUFNLENBQUMsQ0FBQTtZQUU5QyxLQUFLLE1BQU0sTUFBTSxJQUFJLE9BQU8sRUFBRSxDQUFDO2dCQUM3QixJQUFJLE1BQU0sQ0FBQyxPQUFPLEtBQUssTUFBTSxDQUFDLFFBQVEsRUFBRSxDQUFDO29CQUN2QyxNQUFNLENBQUMsUUFBUSxFQUFFLENBQUE7Z0JBQ25CLENBQUM7Z0JBRUQsTUFBTSxDQUFDLE9BQU8sSUFBSSxFQUFFLENBQUE7Z0JBRXBCLElBQUksTUFBTSxDQUFDLE9BQU8sSUFBSSxDQUFDLEVBQUUsQ0FBQztvQkFDeEIsTUFBTSxDQUFDLE9BQU8sR0FBRyxNQUFNLENBQUMsUUFBUSxDQUFB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QVUsWUFBWSxDQUFDLE1BQWMsRUFBRSxNQUFjO0lBQ3pELE1BQU0sU0FBUyxHQUFHLGFBQWEsQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxDQUFBO0lBQ2pELGFBQWEsQ0FBQyxHQUFHLENBQ2YsTUFBTSxFQUNOLFNBQVMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssTUFBTSxDQUFDLENBQzdDLENBQUE7QUFDSCxDQUFDO0FBRUQsTUFBTSxVQUFVLGdCQUFnQixDQUFDLE1BQWM7SUFDN0MsYUFBYSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQTtBQUM5QixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRW50aXR5IH0gZnJvbSAnQGRjbC9lY3MnXG5pbXBvcnQgeyBnZXRUcmlnZ2VyRXZlbnRzIH0gZnJvbSAnLi9ldmVudHMnXG5pbXBvcnQgeyBUcmlnZ2VyVHlwZSB9IGZyb20gJy4vZW51bXMnXG5cbmludGVyZmFjZSBEZWxheUFjdGlvbiB7XG4gIGFjdGlvbjogc3RyaW5nXG4gIHRpbWVvdXQ6IG51bWJlclxuICBjYWxsYmFjazogRnVuY3Rpb25cbn1cblxuaW50ZXJmYWNlIEludGVydmFsQWN0aW9uIHtcbiAgYWN0aW9uOiBzdHJpbmdcbiAgdGltZW91dDogbnVtYmVyXG4gIGludGVydmFsOiBudW1iZXJcbiAgY2FsbGJhY2s6IEZ1bmN0aW9uXG59XG5cbmV4cG9ydCBjb25zdCB0aWNrU2V0ID0gbmV3IFNldDxFbnRpdHk+KClcblxuY29uc3QgcXVldWVEZWxheSA9IG5ldyBNYXA8RW50aXR5LCBBcnJheTxEZWxheUFjdGlvbj4+KClcbmNvbnN0IHF1ZXVlSW50ZXJ2YWwgPSBuZXcgTWFwPEVudGl0eSwgQXJyYXk8SW50ZXJ2YWxBY3Rpb24+PigpXG5cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVUaW1lclN5c3RlbSgpIHtcbiAgcmV0dXJuIGZ1bmN0aW9uIHRpbWVyU3lzdGVtKGR0OiBudW1iZXIpIHtcbiAgICBpbnRlcnZhbFN5c3RlbShkdClcbiAgICBkZWxheVN5c3RlbShkdClcbiAgICB0aWNrU3lzdGVtKGR0KVxuICB9XG5cbiAgZnVuY3Rpb24gaW50ZXJ2YWxTeXN0ZW0oZHQ6IG51bWJlcikge1xuICAgIGZvciAoY29uc3QgW2VudGl0eSwgYWN0aW9uc10gb2YgcXVldWVJbnRlcnZhbC5lbnRyaWVzKCkpIHtcbiAgICAgIGNvbnN0IHRyaWdnZXJFdmVudHMgPSBnZXRUcmlnZ2VyRXZlbnRzKGVudGl0eSlcblxuICAgICAgZm9yIChjb25zdCBhY3Rpb24gb2YgYWN0aW9ucykge1xuICAgICAgICBpZiAoYWN0aW9uLnRpbWVvdXQgPT09IGFjdGlvbi5pbnRlcnZhbCkge1xuICAgICAgICAgIGFjdGlvbi5jYWxsYmFjaygpXG4gICAgICAgIH1cblxuICAgICAgICBhY3Rpb24udGltZW91dCAtPSBkdFxuXG4gICAgICAgIGlmIChhY3Rpb24udGltZW91dCA8PSAwKSB7XG4gICAgICAgICAgYWN0aW9uLnRpbWVvdXQgPSBhY3Rpb24uaW50ZXJ2YWxcbiAgICAgICAgICB0cmlnZ2VyRXZlbnRzLmVtaXQoVHJpZ2dlclR5cGUuT05fTE9PUClcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGZ1bmN0aW9uIGRlbGF5U3lzdGVtKGR0OiBudW1iZXIpIHtcbiAgICBmb3IgKGNvbnN0IFtlbnRpdHksIGFjdGlvbnNdIG9mIHF1ZXVlRGVsYXkuZW50cmllcygpKSB7XG4gICAgICBjb25zdCB0cmlnZ2VyRXZlbnRzID0gZ2V0VHJpZ2dlckV2ZW50cyhlbnRpdHkpXG4gICAgICBjb25zdCBjb21wbGV0ZWRBY3Rpb25zID0gW11cbiAgICAgIGxldCBpZHggPSAwXG5cbiAgICAgIC8vIEl0ZXJhdGUgZW50aXR5IGFjdGlvbnMgYW5kIHZlcmlmeSBpcyB0aGUgdGltZW91dCBpcyByZWFjaGVkIHRvIGV4ZWN1dGUgdGhlIGNhbGxiYWNrXG4gICAgICBmb3IgKGNvbnN0IGFjdGlvbiBvZiBhY3Rpb25zKSB7XG4gICAgICAgIGFjdGlvbi50aW1lb3V0IC09IGR0XG5cbiAgICAgICAgaWYgKGFjdGlvbi50aW1lb3V0IDw9IDApIHtcbiAgICAgICAgICBhY3Rpb24uY2FsbGJhY2soKVxuICAgICAgICAgIHRyaWdnZXJFdmVudHMuZW1pdChUcmlnZ2VyVHlwZS5PTl9ERUxBWSlcbiAgICAgICAgICBjb21wbGV0ZWRBY3Rpb25zLnB1c2goaWR4KVxuICAgICAgICB9XG4gICAgICAgIGlkeCsrXG4gICAgICB9XG5cbiAgICAgIC8vIFJlbW92ZSBjb21wbGV0ZWQgYWN0aW9ucyBmcm9tIHRoZSBxdWV1ZVxuICAgICAgZm9yIChjb25zdCBhY3Rpb24gb2YgY29tcGxldGVkQWN0aW9ucykge1xuICAgICAgICBhY3Rpb25zLnNwbGljZShhY3Rpb24sIDEpXG4gICAgICB9XG4gICAgfVxuICB9XG5cbiAgZnVuY3Rpb24gdGlja1N5c3RlbShfZHQ6IG51bWJlcikge1xuICAgIGZvciAoY29uc3QgZW50aXR5IG9mIHRpY2tTZXQpIHtcbiAgICAgIGNvbnN0IHRyaWdnZXJFdmVudHMgPSBnZXRUcmlnZ2VyRXZlbnRzKGVudGl0eSlcbiAgICAgIHRyaWdnZXJFdmVudHMuZW1pdChUcmlnZ2VyVHlwZS5PTl9USUNLKVxuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gc3RhcnRUaW1lb3V0KFxuICBlbnRpdHk6IEVudGl0eSxcbiAgYWN0aW9uOiBzdHJpbmcsXG4gIHRpbWVvdXQ6IG51bWJlcixcbiAgY2FsbGJhY2s6ICgpID0+IHZvaWQsXG4pIHtcbiAgY29uc3QgYWN0aW9uQ2FsbGJhY2tzID0gcXVldWVEZWxheS5nZXQoZW50aXR5KSA/PyBbXVxuICBhY3Rpb25DYWxsYmFja3MucHVzaCh7IHRpbWVvdXQsIGFjdGlvbiwgY2FsbGJhY2sgfSlcbiAgcXVldWVEZWxheS5zZXQoZW50aXR5LCBhY3Rpb25DYWxsYmFja3MpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdG9wVGltZW91dChlbnRpdHk6IEVudGl0eSwgYWN0aW9uOiBzdHJpbmcpIHtcbiAgY29uc3QgZGVsYXlzID0gcXVldWVEZWxheS5nZXQoZW50aXR5KSA/PyBbXVxuICBxdWV1ZURlbGF5LnNldChcbiAgICBlbnRpdHksXG4gICAgZGVsYXlzLmZpbHRlcigoJCkgPT4gJC5hY3Rpb24gIT09IGFjdGlvbiksXG4gIClcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHN0b3BBbGxUaW1lb3V0cyhlbnRpdHk6IEVudGl0eSkge1xuICBxdWV1ZURlbGF5LmRlbGV0ZShlbnRpdHkpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdGFydEludGVydmFsKFxuICBlbnRpdHk6IEVudGl0eSxcbiAgYWN0aW9uOiBzdHJpbmcsXG4gIGludGVydmFsOiBudW1iZXIsXG4gIGNhbGxiYWNrOiAoKSA9PiB2b2lkLFxuKSB7XG4gIGNvbnN0IGFjdGlvbkNhbGxiYWNrcyA9IHF1ZXVlSW50ZXJ2YWwuZ2V0KGVudGl0eSkgPz8gW11cbiAgYWN0aW9uQ2FsbGJhY2tzLnB1c2goeyB0aW1lb3V0OiBpbnRlcnZhbCwgYWN0aW9uLCBjYWxsYmFjaywgaW50ZXJ2YWwgfSlcbiAgcXVldWVJbnRlcnZhbC5zZXQoZW50aXR5LCBhY3Rpb25DYWxsYmFja3MpXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdG9wSW50ZXJ2YWwoZW50aXR5OiBFbnRpdHksIGFjdGlvbjogc3RyaW5nKSB7XG4gIGNvbnN0IGludGVydmFscyA9IHF1ZXVlSW50ZXJ2YWwuZ2V0KGVudGl0eSkgPz8gW11cbiAgcXVldWVJbnRlcnZhbC5zZXQoXG4gICAgZW50aXR5LFxuICAgIGludGVydmFscy5maWx0ZXIoKCQpID0+ICQuYWN0aW9uICE9PSBhY3Rpb24pLFxuICApXG59XG5cbmV4cG9ydCBmdW5jdGlvbiBzdG9wQWxsSW50ZXJ2YWxzKGVudGl0eTogRW50aXR5KSB7XG4gIHF1ZXVlSW50ZXJ2YWwuZGVsZXRlKGVudGl0eSlcbn1cbiJdfQ==