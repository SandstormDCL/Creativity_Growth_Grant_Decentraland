"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.MemoryTransport = void 0;
const mitt_1 = __importDefault(require("mitt"));
function MemoryTransport(options) {
    var _a;
    const clientEd = (0, mitt_1.default)();
    const serverEd = (0, mitt_1.default)();
    const decouple = (_a = options === null || options === void 0 ? void 0 : options.decouplingFunction) !== null && _a !== void 0 ? _a : ((cb) => cb());
    let connected = false;
    function configureMemoryTransport(receiver, sender) {
        let isClosed = false;
        return {
            ...sender,
            isConnected: connected,
            sendMessage(message) {
                decouple(() => {
                    receiver.emit("message", message);
                });
            },
            close() {
                if (!isClosed) {
                    isClosed = true;
                    sender.emit("close", {});
                }
            },
        };
    }
    const client = configureMemoryTransport(clientEd, serverEd);
    const server = configureMemoryTransport(serverEd, clientEd);
    client.on("message", (message) => {
        if (!connected) {
            connected = true;
            client.emit("connect", {});
        }
    });
    server.on("close", () => client.close());
    client.on("close", () => server.close());
    return {
        client,
        server,
    };
}
exports.MemoryTransport = MemoryTransport;
//# sourceMappingURL=Memory.js.map